<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop - Al Saraya Butchery</title>
    <link rel="stylesheet" href="styles.css">
    <script src="translations.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- Floating Shapes -->
    <div class="floating-shapes">
        <div class="shape shape-1"></div>
        <div class="shape shape-2"></div>
        <div class="shape shape-3"></div>
        <div class="shape shape-4"></div>
    </div>

    <!-- Navigation -->
    <nav id="navbar">
        <div class="container">
            <a href="index.html" class="logo"><img src="https://i.imgur.com/gWdOYdW.png" alt="Al Saraya Butchery" class="logo-img"></a>
            <ul class="nav-links" id="navLinks">
                <li><a href="index.html#home" data-translate="home">Home</a></li>
                <li><a href="index.html#about" data-translate="about">About</a></li>
                <li><a href="shop.html" data-translate="shop">Shop</a></li>
                <li><a href="tracking.html" data-translate="trackOrder">Track Order</a></li>
                <li><a href="index.html#contact" data-translate="contact">Contact</a></li>
                <li class="language-switcher">
                    <button onclick="switchLanguage('en')" class="lang-btn" id="langEn">EN</button>
                    <button onclick="switchLanguage('ar')" class="lang-btn" id="langAr">ÿπ</button>
                </li>
                <li class="cart-icon" id="cartIcon">
                    üõí
                    <span class="cart-count" id="cartCount">0</span>
                </li>
            </ul>
            <div class="mobile-menu" id="menuToggle">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    </nav>

    <!-- Page Hero -->
    <section class="page-hero page-hero-shop">
        <div class="page-hero-content">
            <h1>Our Products</h1>
            <p>Browse our premium selection of meats and specialty products</p>
        </div>
    </section>

    <!-- Sticky Filter Bar -->
    <div class="sticky-filter-bar" id="stickyFilterBar">
        <div class="filter-bar-container">
            <!-- Desktop View -->
            <div class="filter-bar-desktop">
                <div class="filter-item">
                    <label>Category</label>
                    <select id="filterCategory" onchange="applyFilters('desktop-category')">
                        <option value="all">All Categories</option>
                        <!-- Categories loaded dynamically -->
                    </select>
                </div>
                <div class="filter-item">
                    <label>Sort By</label>
                    <select id="filterSort" onchange="applyFilters()">
                        <option value="name-asc">Name (A-Z)</option>
                        <option value="name-desc">Name (Z-A)</option>
                        <option value="price-asc">Price (Low to High)</option>
                        <option value="price-desc">Price (High to Low)</option>
                    </select>
                </div>
                <div class="filter-item search-item">
                    <label>Search</label>
                    <div class="search-input-wrapper">
                        <input type="text" id="filterSearch" placeholder="Search products..." oninput="applyFilters()">
                        <span class="search-icon">üîç</span>
                    </div>
                </div>
                <button class="filter-reset-btn" onclick="resetFilters()">Reset</button>
            </div>

            <!-- Mobile View -->
            <div class="filter-bar-mobile">
                <button class="filter-icon-btn" id="mobileSearchBtn" onclick="toggleMobileFilter('search')" title="Search">
                    <span class="icon">üîç</span>
                </button>
                <button class="filter-icon-btn" id="mobileCategoryBtn" onclick="toggleMobileFilter('category')" title="Category">
                    <span class="icon">üìÅ</span>
                </button>
                <button class="filter-icon-btn" id="mobileSortBtn" onclick="toggleMobileFilter('sort')" title="Sort">
                    <span class="icon">‚ÜïÔ∏è</span>
                </button>
                <button class="filter-icon-btn" id="mobileResetBtn" onclick="resetFilters()" title="Reset">
                    <span class="icon">üîÑ</span>
                </button>
            </div>

            <!-- Mobile Expanded Panels -->
            <div class="mobile-filter-panel" id="mobileSearchPanel">
                <div class="mobile-panel-content">
                    <input type="text" id="mobileFilterSearch" placeholder="Search products..." oninput="applyFilters()">
                    <button class="panel-close-btn" onclick="closeMobilePanel()">‚úï</button>
                </div>
            </div>
            <div class="mobile-filter-panel" id="mobileCategoryPanel">
                <div class="mobile-panel-content">
                    <select id="mobileFilterCategory" onchange="applyFilters('mobile-category'); closeMobilePanel();">
                        <option value="all">All Categories</option>
                    </select>
                    <button class="panel-close-btn" onclick="closeMobilePanel()">‚úï</button>
                </div>
            </div>
            <div class="mobile-filter-panel" id="mobileSortPanel">
                <div class="mobile-panel-content">
                    <select id="mobileFilterSort" onchange="applyFilters(); closeMobilePanel();">
                        <option value="name-asc">Name (A-Z)</option>
                        <option value="name-desc">Name (Z-A)</option>
                        <option value="price-asc">Price (Low to High)</option>
                        <option value="price-desc">Price (High to Low)</option>
                    </select>
                    <button class="panel-close-btn" onclick="closeMobilePanel()">‚úï</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Shop Section -->
    <section class="shop reveal" id="shop">
        <div class="shop-layout">
            <!-- Left Sidebar Filters (Desktop) -->
            <aside class="sidebar-filters">
                <h3>Categories</h3>
                <div id="sidebarCategories">
                    <!-- "All Products" is always shown -->
                    <div class="filter-category active" data-filter="all">
                        <div class="cat-icon">üõí</div>
                        <div class="cat-info">
                            <div class="cat-name">All Products</div>
                            <div class="cat-count">View Everything</div>
                        </div>
                    </div>
                    <!-- Categories loaded dynamically from Supabase -->
                    <div class="loading-categories" style="padding: 1rem; color: #94A3B8; text-align: center;">Loading...</div>
                </div>

                <!-- Filter Options -->
                <div class="filter-options">
                    <h4>Filter By</h4>
                    <div class="filter-checkboxes">
                        <div class="filter-checkbox">
                            <input type="checkbox" id="inStock" checked>
                            <label for="inStock">In Stock Only</label>
                        </div>
                        <div class="filter-checkbox">
                            <input type="checkbox" id="premiumOnly">
                            <label for="premiumOnly">Premium Products</label>
                        </div>
                        <div class="filter-checkbox">
                            <input type="checkbox" id="newArrivals">
                            <label for="newArrivals">New Arrivals</label>
                        </div>
                    </div>

                    <div class="price-range">
                        <h4>Price Range</h4>
                        <div class="price-inputs">
                            <input type="number" placeholder="Min" id="minPrice">
                            <input type="number" placeholder="Max" id="maxPrice">
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Products Grid -->
            <div class="products-container">
                <!-- Mobile Filters (shown on mobile) -->
                <div class="filters" id="mobileFilters">
                    <button class="filter-btn active" data-filter="all" data-icon="üõí">All</button>
                    <!-- Categories loaded dynamically from Supabase -->
                </div>

                <div class="products-grid" id="productsGrid">
                    <!-- Products will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </section>

    <!-- Mobile Bottom Navigation -->
    <nav class="mobile-bottom-nav">
        <a href="index.html" class="nav-item">
            <div class="nav-icon">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
                </svg>
            </div>
            <span>Home</span>
        </a>
        <a href="shop.html" class="nav-item active">
            <div class="nav-icon">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/>
                </svg>
            </div>
            <span>Shop</span>
        </a>
        <a href="#" id="cartIconBottom" class="nav-item cart-item-nav">
            <div class="nav-icon cart-icon-wrapper">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/>
                </svg>
                <span class="cart-count" id="cartCountMobile">0</span>
            </div>
            <span>Cart</span>
        </a>
        <a href="tracking.html" class="nav-item">
            <div class="nav-icon">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M20 8h-3V4H3c-1.1 0-2 .9-2 2v11h2c0 1.66 1.34 3 3 3s3-1.34 3-3h6c0 1.66 1.34 3 3 3s3-1.34 3-3h2v-5l-3-4zM6 18.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm13.5-9l1.96 2.5H17V9.5h2.5zm-1.5 9c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/>
                </svg>
            </div>
            <span>Track</span>
        </a>
        <a href="index.html#contact" class="nav-item">
            <div class="nav-icon">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10h5v-2h-5c-4.34 0-8-3.66-8-8s3.66-8 8-8 8 3.66 8 8v1.43c0 .79-.71 1.57-1.5 1.57s-1.5-.78-1.5-1.57V12c0-2.76-2.24-5-5-5s-5 2.24-5 5 2.24 5 5 5c1.38 0 2.64-.56 3.54-1.47.65.89 1.77 1.47 2.96 1.47 1.97 0 3.5-1.6 3.5-3.57V12c0-5.52-4.48-10-10-10zm0 13c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3z"/>
                </svg>
            </div>
            <span>Contact</span>
        </a>
    </nav>

    <!-- Footer -->
    <footer>
        <div class="footer-content">
            <div class="footer-section">
                <h3>Al Saraya</h3>
                <p>Your trusted source for premium quality meats since 1995. We're committed to excellence in every cut.</p>
                <div class="social-links">
                    <a href="#" class="social-icon">f</a>
                    <a href="#" class="social-icon">üì∑</a>
                    <a href="#" class="social-icon">ùïè</a>
                    <a href="#" class="social-icon">in</a>
                </div>
            </div>
            <div class="footer-section">
                <h3>Quick Links</h3>
                <div class="footer-links">
                    <a href="index.html#home">Home</a>
                    <a href="index.html#about">About Us</a>
                    <a href="shop.html">Shop</a>
                    <a href="tracking.html">Track Order</a>
                    <a href="index.html#contact">Contact</a>
                </div>
            </div>
            <div class="footer-section">
                <h3>Products</h3>
                <div class="footer-links">
                    <a href="shop.html">Fresh Beef</a>
                    <a href="shop.html">Premium Lamb</a>
                    <a href="shop.html">Farm Chicken</a>
                    <a href="shop.html">Specialty Cuts</a>
                </div>
            </div>
            <div class="footer-section">
                <h3>Information</h3>
                <div class="footer-links">
                    <a href="#">Privacy Policy</a>
                    <a href="#">Terms of Service</a>
                    <a href="#">Delivery Info</a>
                    <a href="#">FAQ</a>
                </div>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2026 Al Saraya Butchery. All rights reserved. Crafted with passion.</p>
        </div>
    </footer>

    <!-- Cart Modal -->
    <div class="cart-modal" id="cartModal">
        <div class="cart-content">
            <div class="cart-header">
                <h2>Shopping Cart</h2>
                <button class="close-cart" id="closeCart">&times;</button>
            </div>
            <div class="cart-items" id="cartItems">
                <!-- Cart items will be populated by JavaScript -->
            </div>
            <div class="cart-total">
                <span>Total:</span>
                <span id="cartTotal">0.00 AED</span>
            </div>
            <button class="btn btn-primary" style="width: 100%;" onclick="proceedToCheckout()">Proceed to Checkout</button>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        // Initialize Supabase - Use app.js global client
        const shopSupabase = supabase;

        let allProducts = [];
        let allCategories = [];

        // Fetch categories from database
        async function fetchCategories() {
            try {
                const { data, error } = await shopSupabase
                    .from('categories')
                    .select('*')
                    .order('name');

                if (error) throw error;

                allCategories = data || [];
                renderCategories(allCategories);
                populateFilterBar(allCategories);
            } catch (error) {
                console.error('Error fetching categories:', error);
                // Remove loading indicator
                const loadingEl = document.querySelector('.loading-categories');
                if (loadingEl) loadingEl.remove();
            }
        }

        // Render categories in sidebar and mobile filters
        function renderCategories(categories) {
            const sidebarContainer = document.getElementById('sidebarCategories');
            const mobileContainer = document.getElementById('mobileFilters');

            // Remove loading indicator
            const loadingEl = document.querySelector('.loading-categories');
            if (loadingEl) loadingEl.remove();

            // Render sidebar categories
            if (sidebarContainer) {
                const sidebarHTML = categories.map(cat => `
                    <div class="filter-category" data-filter="${cat.slug}">
                        <div class="cat-icon">${cat.icon || 'üì¶'}</div>
                        <div class="cat-info">
                            <div class="cat-name">${cat.name}</div>
                            <div class="cat-count">${cat.description || ''}</div>
                        </div>
                    </div>
                `).join('');

                sidebarContainer.insertAdjacentHTML('beforeend', sidebarHTML);

                // Add click handlers for new categories
                sidebarContainer.querySelectorAll('.filter-category').forEach(cat => {
                    cat.addEventListener('click', (e) => {
                        const element = e.currentTarget;
                        document.querySelectorAll('.filter-category').forEach(c => c.classList.remove('active'));
                        element.classList.add('active');
                        renderProducts(element.dataset.filter);

                        // Also update mobile filter buttons
                        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                        const matchingBtn = document.querySelector(`.filter-btn[data-filter="${element.dataset.filter}"]`);
                        if (matchingBtn) matchingBtn.classList.add('active');
                    });
                });
            }

            // Render mobile filter buttons
            if (mobileContainer) {
                const mobileHTML = categories.map(cat => `
                    <button class="filter-btn" data-filter="${cat.slug}" data-icon="${cat.icon || 'üì¶'}">${cat.name}</button>
                `).join('');

                mobileContainer.insertAdjacentHTML('beforeend', mobileHTML);

                // Add click handlers for new buttons
                mobileContainer.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        renderProducts(e.target.dataset.filter);

                        // Also update sidebar categories
                        document.querySelectorAll('.filter-category').forEach(c => c.classList.remove('active'));
                        const matchingCat = document.querySelector(`.filter-category[data-filter="${e.target.dataset.filter}"]`);
                        if (matchingCat) matchingCat.classList.add('active');
                    });
                });
            }
        }

        // Fetch products from database
        async function fetchProducts() {
            try {
                const { data, error } = await shopSupabase
                    .from('products')
                    .select('*')
                    .eq('in_stock', true)
                    .order('name');

                if (error) throw error;

                allProducts = data;
                renderProducts('all');
            } catch (error) {
                console.error('Error fetching products:', error);
                document.getElementById('productsGrid').innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 3rem; color: #94A3B8;">
                        <h3>Unable to load products</h3>
                        <p>Please check your database connection or import products using import-products.sql</p>
                    </div>
                `;
            }
        }

        // Render Products
        function renderProducts(filter = 'all') {
            const grid = document.getElementById('productsGrid');
            const currentLang = localStorage.getItem('language') || 'en';

            let filtered = filter === 'all'
                ? allProducts
                : allProducts.filter(p => {
                    // Find category by slug
                    const selectedCategory = allCategories.find(c => c.slug === filter);
                    if (selectedCategory) {
                        // Primary: Match by category_id (proper foreign key relationship)
                        if (p.category_id) {
                            return p.category_id === selectedCategory.id;
                        }
                        // Fallback: Match by category name/slug (for backward compatibility)
                        if (p.category) {
                            const productCat = p.category.toLowerCase();
                            return productCat === selectedCategory.name.toLowerCase() ||
                                   productCat === selectedCategory.slug.toLowerCase();
                        }
                    }
                    return false;
                });

            if (filtered.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 3rem; color: #94A3B8;">
                        <h3>No products found</h3>
                        <p>Try selecting a different category</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = filtered.map(product => {
                const displayName = currentLang === 'ar' && product.arabic_name ? product.arabic_name : product.name;
                const defaultImage = 'https://images.unsplash.com/photo-1607623814075-e51df1bdc82f?w=500&h=350&fit=crop';
                const productImage = product.image_url || defaultImage;
                
                return `
                    <div class="product-card" data-category="${product.category}">
                        <div class="product-image">
                            <a href="product-detail.html?id=${product.id}">
                                <img src="${productImage}" alt="${displayName}" loading="lazy">
                            </a>
                            ${product.badge ? `<div class="product-badge">${product.badge}</div>` : ''}
                        </div>
                        <div class="product-info">
                            <h3 class="product-title">
                                <a href="product-detail.html?id=${product.id}">${displayName}</a>
                            </h3>
                            <p class="product-description">${product.description || ''}</p>
                            <div class="product-footer">
                                <div class="product-price">
                                    ${parseFloat(product.price).toFixed(2)} AED<span>/${product.unit || 'kg'}</span>
                                </div>
                                <button class="add-to-cart" onclick="addToCartFromDB(${product.id}, '${product.name.replace(/'/g, "\\'")}', ${product.price}, '${product.category}', '${product.unit || 'kg'}', '${product.iiko_product_id || ''}')">
                                    Add to Cart
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Re-apply reveal animation
            setTimeout(() => {
                document.querySelectorAll('.product-card').forEach((card, index) => {
                    card.style.opacity = '0';
                    card.style.transform = 'translateY(30px)';
                    setTimeout(() => {
                        card.style.transition = 'all 0.5s ease';
                        card.style.opacity = '1';
                        card.style.transform = 'translateY(0)';
                    }, 50 + (index * 50));
                });
            }, 50);
        }

        // Add to cart function for database products
        function addToCartFromDB(id, name, price, category, unit) {
            const product = {
                id: id,
                name: name,
                price: parseFloat(price),
                category: category,
                unit: unit
            };
            
            // Update the global cart variable from app.js
            if (typeof cart !== 'undefined') {
                const existingItem = cart.find(item => item.id === product.id);
                if (existingItem) {
                    existingItem.quantity += 1;
                } else {
                    cart.push({ ...product, quantity: 1 });
                }
                localStorage.setItem('cart', JSON.stringify(cart));
            } else {
                // Fallback if cart is not defined
                let localCart = JSON.parse(localStorage.getItem('cart')) || [];
                const existingItem = localCart.find(item => item.id === product.id);
                if (existingItem) {
                    existingItem.quantity += 1;
                } else {
                    localCart.push({ ...product, quantity: 1 });
                }
                localStorage.setItem('cart', JSON.stringify(localCart));
            }

            updateCartCount();
            showNotification(`${name} added to cart!`);
        }

        // Load categories and products on page load
        fetchCategories();
        fetchProducts();

        // Filter Products - Event listeners added dynamically in renderCategories()
        document.addEventListener('DOMContentLoaded', () => {
            // "All" button click handler (always present)
            const allBtn = document.querySelector('.filter-btn[data-filter="all"]');
            if (allBtn) {
                allBtn.addEventListener('click', (e) => {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    renderProducts('all');
                    document.querySelectorAll('.filter-category').forEach(c => c.classList.remove('active'));
                    const allCat = document.querySelector('.filter-category[data-filter="all"]');
                    if (allCat) allCat.classList.add('active');
                });
            }

            // "All Products" sidebar click handler (always present)
            const allCat = document.querySelector('.filter-category[data-filter="all"]');
            if (allCat) {
                allCat.addEventListener('click', (e) => {
                    document.querySelectorAll('.filter-category').forEach(c => c.classList.remove('active'));
                    e.currentTarget.classList.add('active');
                    renderProducts('all');
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    const allBtn = document.querySelector('.filter-btn[data-filter="all"]');
                    if (allBtn) allBtn.classList.add('active');
                });
            }

            // Mobile Bottom Nav Cart Icon
            const cartIconBottom = document.getElementById('cartIconBottom');
            if (cartIconBottom) {
                cartIconBottom.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.getElementById('cartModal').classList.add('active');
                    displayCart();
                });
            }

            // Additional filter options
            const inStockCheckbox = document.getElementById('inStock');
            const premiumCheckbox = document.getElementById('premiumOnly');
            const minPriceInput = document.getElementById('minPrice');
            const maxPriceInput = document.getElementById('maxPrice');

            if (inStockCheckbox) {
                inStockCheckbox.addEventListener('change', () => fetchProducts());
            }

            if (premiumCheckbox) {
                premiumCheckbox.addEventListener('change', () => {
                    const activeFilter = document.querySelector('.filter-category.active');
                    if (activeFilter) renderProducts(activeFilter.dataset.filter);
                });
            }

            if (minPriceInput || maxPriceInput) {
                [minPriceInput, maxPriceInput].forEach(input => {
                    if (input) {
                        input.addEventListener('input', () => {
                            const activeFilter = document.querySelector('.filter-category.active');
                            if (activeFilter) renderProducts(activeFilter.dataset.filter);
                        });
                    }
                });
            }
        });

        // ============================================
        // STICKY FILTER BAR FUNCTIONS
        // ============================================

        // Populate filter bar dropdowns
        function populateFilterBar(categories) {
            const desktopSelect = document.getElementById('filterCategory');
            const mobileSelect = document.getElementById('mobileFilterCategory');

            const optionsHTML = categories.map(cat =>
                `<option value="${cat.slug}">${cat.name}</option>`
            ).join('');

            if (desktopSelect) {
                desktopSelect.innerHTML = '<option value="all">All Categories</option>' + optionsHTML;
            }
            if (mobileSelect) {
                mobileSelect.innerHTML = '<option value="all">All Categories</option>' + optionsHTML;
            }
        }

        // Apply all filters
        function applyFilters(source = '') {
            // Get filter values - use source to determine which input triggered the change
            const categoryDesktop = document.getElementById('filterCategory')?.value || 'all';
            const categoryMobile = document.getElementById('mobileFilterCategory')?.value || 'all';

            // Determine category based on which input triggered the change
            let category;
            if (source === 'desktop-category') {
                category = categoryDesktop;
            } else if (source === 'mobile-category') {
                category = categoryMobile;
            } else {
                // For non-category changes, use whichever is not 'all' (prefer current state)
                category = categoryDesktop !== 'all' ? categoryDesktop : categoryMobile;
            }

            const sortDesktop = document.getElementById('filterSort')?.value || 'name-asc';
            const sortMobile = document.getElementById('mobileFilterSort')?.value || 'name-asc';
            const sortBy = sortMobile !== 'name-asc' ? sortMobile : sortDesktop;

            const searchDesktop = document.getElementById('filterSearch')?.value?.toLowerCase() || '';
            const searchMobile = document.getElementById('mobileFilterSearch')?.value?.toLowerCase() || '';
            const searchTerm = searchMobile || searchDesktop;

            // Sync values between desktop and mobile
            if (document.getElementById('filterCategory')) document.getElementById('filterCategory').value = category;
            if (document.getElementById('mobileFilterCategory')) document.getElementById('mobileFilterCategory').value = category;
            if (document.getElementById('filterSort')) document.getElementById('filterSort').value = sortBy;
            if (document.getElementById('mobileFilterSort')) document.getElementById('mobileFilterSort').value = sortBy;

            // Scroll to top of products when category changes
            if (source === 'desktop-category' || source === 'mobile-category') {
                const shopSection = document.getElementById('shop');
                if (shopSection) {
                    const offset = 150; // Account for sticky header and filter bar
                    const shopTop = shopSection.offsetTop - offset;
                    window.scrollTo({ top: shopTop, behavior: 'smooth' });
                }
            }

            // Filter products
            let filtered = [...allProducts];

            // Category filter
            if (category !== 'all') {
                const selectedCategory = allCategories.find(c => c.slug === category);
                if (selectedCategory) {
                    filtered = filtered.filter(p => {
                        if (p.category_id) {
                            return p.category_id === selectedCategory.id;
                        }
                        if (p.category) {
                            const productCat = p.category.toLowerCase();
                            return productCat === selectedCategory.name.toLowerCase() ||
                                   productCat === selectedCategory.slug.toLowerCase();
                        }
                        return false;
                    });
                }
            }

            // Search filter
            if (searchTerm) {
                filtered = filtered.filter(p =>
                    p.name.toLowerCase().includes(searchTerm) ||
                    (p.arabic_name && p.arabic_name.toLowerCase().includes(searchTerm)) ||
                    (p.description && p.description.toLowerCase().includes(searchTerm))
                );
            }

            // Sort products
            filtered.sort((a, b) => {
                switch (sortBy) {
                    case 'name-asc':
                        return a.name.localeCompare(b.name);
                    case 'name-desc':
                        return b.name.localeCompare(a.name);
                    case 'price-asc':
                        return parseFloat(a.price) - parseFloat(b.price);
                    case 'price-desc':
                        return parseFloat(b.price) - parseFloat(a.price);
                    default:
                        return 0;
                }
            });

            // Update sidebar/mobile category buttons
            document.querySelectorAll('.filter-category').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            const activeCat = document.querySelector(`.filter-category[data-filter="${category}"]`);
            const activeBtn = document.querySelector(`.filter-btn[data-filter="${category}"]`);
            if (activeCat) activeCat.classList.add('active');
            if (activeBtn) activeBtn.classList.add('active');

            // Render filtered products
            renderFilteredProducts(filtered);
        }

        // Render filtered products (similar to renderProducts but takes array)
        function renderFilteredProducts(products) {
            const grid = document.getElementById('productsGrid');
            const currentLang = localStorage.getItem('language') || 'en';

            if (products.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 3rem; color: #94A3B8;">
                        <h3>No products found</h3>
                        <p>Try adjusting your filters</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = products.map(product => {
                const displayName = currentLang === 'ar' && product.arabic_name ? product.arabic_name : product.name;
                const defaultImage = 'https://images.unsplash.com/photo-1607623814075-e51df1bdc82f?w=500&h=350&fit=crop';
                const productImage = product.image_url || defaultImage;

                return `
                    <div class="product-card" data-category="${product.category}">
                        <div class="product-image">
                            <a href="product-detail.html?id=${product.id}">
                                <img src="${productImage}" alt="${displayName}" loading="lazy">
                            </a>
                            ${product.badge ? `<div class="product-badge">${product.badge}</div>` : ''}
                        </div>
                        <div class="product-info">
                            <h3 class="product-title">
                                <a href="product-detail.html?id=${product.id}">${displayName}</a>
                            </h3>
                            <p class="product-description">${product.description || ''}</p>
                            <div class="product-footer">
                                <div class="product-price">
                                    ${parseFloat(product.price).toFixed(2)} AED<span>/${product.unit || 'kg'}</span>
                                </div>
                                <button class="add-to-cart" onclick="addToCartFromDB(${product.id}, '${product.name.replace(/'/g, "\\'")}', ${product.price}, '${product.category}', '${product.unit || 'kg'}', '${product.iiko_product_id || ''}')">
                                    Add to Cart
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Re-apply reveal animation
            setTimeout(() => {
                document.querySelectorAll('.product-card').forEach((card, index) => {
                    card.style.opacity = '0';
                    card.style.transform = 'translateY(30px)';
                    setTimeout(() => {
                        card.style.transition = 'all 0.5s ease';
                        card.style.opacity = '1';
                        card.style.transform = 'translateY(0)';
                    }, 50 + (index * 30));
                });
            }, 50);
        }

        // Reset all filters
        function resetFilters() {
            // Reset all filter inputs
            if (document.getElementById('filterCategory')) document.getElementById('filterCategory').value = 'all';
            if (document.getElementById('filterSort')) document.getElementById('filterSort').value = 'name-asc';
            if (document.getElementById('filterSearch')) document.getElementById('filterSearch').value = '';
            if (document.getElementById('mobileFilterCategory')) document.getElementById('mobileFilterCategory').value = 'all';
            if (document.getElementById('mobileFilterSort')) document.getElementById('mobileFilterSort').value = 'name-asc';
            if (document.getElementById('mobileFilterSearch')) document.getElementById('mobileFilterSearch').value = '';

            // Close mobile panels
            closeMobilePanel();

            // Reset sidebar/mobile buttons
            document.querySelectorAll('.filter-category').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            const allCat = document.querySelector('.filter-category[data-filter="all"]');
            const allBtn = document.querySelector('.filter-btn[data-filter="all"]');
            if (allCat) allCat.classList.add('active');
            if (allBtn) allBtn.classList.add('active');

            // Render all products
            renderProducts('all');
        }

        // Toggle mobile filter panels
        function toggleMobileFilter(type) {
            const panels = ['search', 'category', 'sort'];
            const buttons = {
                search: document.getElementById('mobileSearchBtn'),
                category: document.getElementById('mobileCategoryBtn'),
                sort: document.getElementById('mobileSortBtn')
            };

            panels.forEach(panel => {
                const panelEl = document.getElementById(`mobile${panel.charAt(0).toUpperCase() + panel.slice(1)}Panel`);
                if (panel === type) {
                    panelEl.classList.toggle('active');
                    buttons[panel]?.classList.toggle('active');

                    // Focus input if search panel opened
                    if (panel === 'search' && panelEl.classList.contains('active')) {
                        setTimeout(() => {
                            document.getElementById('mobileFilterSearch')?.focus();
                        }, 100);
                    }
                } else {
                    panelEl.classList.remove('active');
                    buttons[panel]?.classList.remove('active');
                }
            });
        }

        // Close all mobile panels
        function closeMobilePanel() {
            document.querySelectorAll('.mobile-filter-panel').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.filter-icon-btn').forEach(b => b.classList.remove('active'));
        }

        // Show/hide sticky filter bar on scroll
        const stickyFilterBar = document.getElementById('stickyFilterBar');
        const pageHero = document.querySelector('.page-hero-shop');

        function handleScroll() {
            if (!pageHero || !stickyFilterBar) return;

            const heroBottom = pageHero.offsetTop + pageHero.offsetHeight;
            const scrollY = window.scrollY;

            // Show filter bar after scrolling past the hero section
            if (scrollY > heroBottom - 100) {
                stickyFilterBar.classList.add('visible');
            } else {
                stickyFilterBar.classList.remove('visible');
            }
        }

        // Add scroll listener
        window.addEventListener('scroll', handleScroll);
        // Check initial state
        handleScroll();
    </script>
</body>
</html>
