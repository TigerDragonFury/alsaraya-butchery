<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="foodking2.css">
    <script src="load-components.js"></script>
    <title>My Profile - Al Saraya Butchery</title>
    <link rel="icon" type="image/png" href="https://i.imgur.com/gWdOYdW.png">
    
    <!-- Supabase (for database) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Firebase (for FREE phone authentication) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="firebase-config.js"></script>
    
    <!-- Google Maps Places API (for address autocomplete) -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAqs6k9yZisdszgk-eUYZIryRyRSEgVR6M&libraries=places" async defer></script>
    
    <style>
        :root {
            --profile-gradient-start: #667eea;
            --profile-gradient-end: #764ba2;
            --profile-card-shadow: 0 10px 30px rgba(0,0,0,0.08);
            --profile-card-shadow-hover: 0 15px 40px rgba(0,0,0,0.12);
            --profile-accent: #667eea;
            --profile-accent-light: #f3f4ff;
        }
        
        .page-hero {
            margin-top: 142px;
            background: linear-gradient(135deg, var(--profile-gradient-start) 0%, var(--profile-gradient-end) 100%);
            padding: clamp(56px, 9vw, 88px) 0;
            text-align: center;
            color: var(--white);
            position: relative;
            overflow: hidden;
        }
        
        .page-hero::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 30% 50%, rgba(255,255,255,0.1) 0%, transparent 50%);
            pointer-events: none;
        }
        
        .page-hero h1 {
            font-size: clamp(2.2rem, 5.5vw, 3.4rem);
            font-weight: 800;
            margin-bottom: 0.75rem;
            position: relative;
            z-index: 1;
            text-shadow: 0 2px 10px rgba(0,0,0,0.1);
            letter-spacing: -0.015em;
        }
        
        .page-hero p {
            font-size: clamp(1rem, 1.5vw, 1.15rem);
            opacity: 0.95;
            position: relative;
            z-index: 1;
        }
        
        .profile-section {
            padding: clamp(56px, 8vw, 88px) 0 clamp(64px, 8vw, 108px);
            background: linear-gradient(to bottom, #f8f9fa 0%, #ffffff 100%);
            min-height: 60vh;
        }
        
        .profile-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1.5rem;
        }
        
        .profile-grid {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 2.5rem;
            margin-top: -50px;
            position: relative;
            z-index: 10;
        }
        
        .profile-sidebar {
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.98), rgba(250, 245, 238, 0.96));
            border-radius: 20px;
            padding: 2.5rem;
            box-shadow: 0 12px 30px rgba(50, 25, 20, 0.08);
            height: fit-content;
            position: sticky;
            top: 120px;
            border: 1px solid rgba(139, 17, 0, 0.08);
            transition: all 0.3s ease;
        }
        
        .profile-sidebar:hover {
            box-shadow: 0 16px 38px rgba(50, 25, 20, 0.12);
            transform: translateY(-2px);
        }
        
        .profile-avatar {
            width: 140px;
            height: 140px;
            background: linear-gradient(135deg, var(--profile-gradient-start), var(--profile-gradient-end));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: 3.5rem;
            margin: 0 auto 1.5rem;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
            font-weight: 700;
            position: relative;
            overflow: hidden;
        }
        
        .profile-avatar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at top right, rgba(255,255,255,0.3), transparent);
        }
        
        .profile-name {
            text-align: center;
            margin-bottom: 0.5rem;
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .profile-phone {
            text-align: center;
            color: var(--text-secondary);
            margin-bottom: 2rem;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .profile-phone i {
            color: var(--profile-accent);
        }
        
        .profile-menu {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .profile-menu li {
            margin-bottom: 0.75rem;
        }
        
        .profile-menu a {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.25rem;
            color: var(--text-primary);
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.3s ease;
            font-weight: 500;
            position: relative;
            overflow: hidden;
        }
        
        .profile-menu a::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: var(--profile-accent);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }
        
        .profile-menu a:hover {
            background: var(--profile-accent-light);
            color: var(--profile-accent);
            transform: translateX(5px);
        }
        
        .profile-menu a.active {
            background: linear-gradient(135deg, var(--profile-accent-light), rgba(102, 126, 234, 0.1));
            color: var(--profile-accent);
            font-weight: 600;
        }
        
        .profile-menu a.active::before {
            transform: scaleY(1);
        }
        
        .profile-menu i {
            width: 24px;
            text-align: center;
            font-size: 1.1rem;
        }
        
        .profile-content {
            background: var(--white);
            border-radius: 20px;
            padding: 3rem;
            box-shadow: var(--profile-card-shadow);
            border: 1px solid rgba(0,0,0,0.05);
            animation: fadeInUp 0.6s ease;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .section-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 2rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--profile-accent-light);
        }
        
        .section-title::before {
            content: '';
            width: 4px;
            height: 30px;
            background: linear-gradient(to bottom, var(--profile-gradient-start), var(--profile-gradient-end));
            border-radius: 10px;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 2rem;
            margin-bottom: 2.5rem;
        }
        
        .info-item {
            position: relative;
        }
        
        .info-item label {
            display: block;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .info-item label i {
            color: var(--profile-accent);
            font-size: 0.9rem;
        }
        
        .info-item input {
            width: 100%;
            padding: 1rem 1.25rem;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: #fafafa;
        }
        
        .info-item input:focus {
            outline: none;
            border-color: var(--profile-accent);
            background: var(--white);
            box-shadow: 0 0 0 4px var(--profile-accent-light);
        }
        
        .info-item input:read-only {
            background: #f5f5f5;
            cursor: not-allowed;
        }
        
        .btn-primary {
            padding: 1rem 2.5rem;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--profile-gradient-start), var(--profile-gradient-end));
            border: none;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        .orders-list {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        .order-card {
            background: linear-gradient(to right, #ffffff, #fafbfc);
            border: 2px solid #e5e7eb;
            border-radius: 16px;
            padding: 2rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .order-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 5px;
            background: linear-gradient(to bottom, var(--profile-gradient-start), var(--profile-gradient-end));
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }
        
        .order-card:hover {
            border-color: var(--profile-accent);
            box-shadow: var(--profile-card-shadow);
            transform: translateY(-3px);
        }
        
        .order-card:hover::before {
            transform: scaleY(1);
        }
        
        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .order-id {
            font-weight: 700;
            color: var(--text-primary);
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .order-id i {
            color: var(--profile-accent);
        }
        
        .order-status {
            padding: 0.6rem 1.25rem;
            border-radius: 50px;
            font-size: 0.85rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .status-pending { background: linear-gradient(135deg, #FEF3C7, #FCD34D); color: #92400E; }
        .status-confirmed { background: linear-gradient(135deg, #DBEAFE, #93C5FD); color: #1E40AF; }
        .status-processing { background: linear-gradient(135deg, #E0E7FF, #C7D2FE); color: #4338CA; }
        .status-delivered { background: linear-gradient(135deg, #D1FAE5, #6EE7B7); color: #065F46; }
        .status-cancelled { background: linear-gradient(135deg, #FEE2E2, #FECACA); color: #991B1B; }
        
        .order-details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .order-detail-item {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            padding: 1rem;
            background: var(--profile-accent-light);
            border-radius: 10px;
        }
        
        .order-detail-item label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .order-detail-item span {
            font-weight: 700;
            color: var(--text-primary);
            font-size: 1.05rem;
        }
        
        .order-items {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 2px solid #f0f0f0;
        }
        
        .order-items h4 {
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .order-items h4 i {
            color: var(--profile-accent);
        }
        
        .order-item {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            color: var(--text-secondary);
            font-size: 0.95rem;
            border-bottom: 1px solid #f5f5f5;
        }
        
        .order-item:last-child {
            border-bottom: none;
        }
        
        .empty-state {
            text-align: center;
            padding: 5rem 2rem;
            color: var(--text-secondary);
        }
        
        .empty-state i {
            font-size: 5rem;
            color: var(--profile-accent);
            margin-bottom: 1.5rem;
            opacity: 0.3;
        }
        
        .empty-state h3 {
            margin-bottom: 0.75rem;
            color: var(--text-primary);
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .empty-state p {
            font-size: 1.05rem;
            margin-bottom: 2rem;
        }
        
        .address-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }
        
        .address-card {
            background: linear-gradient(135deg, #ffffff, #fafbfc);
            border: 2px solid #e5e7eb;
            border-radius: 16px;
            padding: 2rem;
            position: relative;
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .address-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(to right, var(--profile-gradient-start), var(--profile-gradient-end));
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }
        
        .address-card:hover {
            border-color: var(--profile-accent);
            box-shadow: var(--profile-card-shadow);
            transform: translateY(-3px);
        }
        
        .address-card:hover::before {
            transform: scaleX(1);
        }
        
        .address-card.default {
            border-color: var(--profile-accent);
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05), rgba(255,255,255,0.95));
        }
        
        .address-card.default::before {
            transform: scaleX(1);
        }
        
        .address-label {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--profile-accent);
            color: var(--white);
            border-radius: 50px;
            font-size: 0.85rem;
            font-weight: 700;
            margin-bottom: 1.25rem;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }
        
        .address-card.default .address-label {
            background: linear-gradient(135deg, var(--profile-gradient-start), var(--profile-gradient-end));
        }
        
        .address-name {
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
            font-size: 1.1rem;
        }
        
        .address-text {
            color: var(--text-secondary);
            font-size: 0.95rem;
            line-height: 1.7;
        }
        
        .address-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 2px solid #f0f0f0;
        }
        
        .address-actions button {
            flex: 1;
            padding: 0.75rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .btn-edit {
            background: var(--profile-accent-light);
            color: var(--profile-accent);
        }
        
        .btn-edit:hover {
            background: var(--profile-accent);
            color: var(--white);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .btn-delete {
            background: #FEE2E2;
            color: #DC2626;
        }
        
        .btn-delete:hover {
            background: #DC2626;
            color: var(--white);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
        }
        
        @media (max-width: 1024px) {
            .profile-grid {
                grid-template-columns: 1fr;
                margin-top: 0;
            }
            
            .profile-sidebar {
                position: static;
            }
            
            .profile-content {
                padding: 2rem;
            }
        }
        
        @media (max-width: 768px) {
            .page-hero {
                margin-top: 70px;
                padding: 40px 0;
            }
            
            .page-hero h1 {
                font-size: 1.75rem;
            }
            
            .page-hero p {
                font-size: 0.95rem;
            }
            
            .profile-section {
                padding: 30px 0 150px;
                overflow-y: auto;
            }
            
            .profile-container {
                padding: 0 1rem;
            }
            
            .profile-sidebar {
                padding: 1.5rem;
                border-radius: 16px;
            }
            
            .profile-avatar {
                width: 100px;
                height: 100px;
                font-size: 2.5rem;
            }
            
            .profile-name {
                font-size: 1.3rem;
            }
            
            .profile-phone {
                font-size: 0.9rem;
                margin-bottom: 1.5rem;
            }
            
            .profile-menu a {
                padding: 0.85rem 1rem;
                font-size: 0.95rem;
            }
            
            .profile-menu i {
                font-size: 1rem;
            }
            
            .profile-content {
                padding: 1.5rem;
                border-radius: 16px;
            }
            
            .section-title {
                font-size: 1.4rem;
                margin-bottom: 1.5rem;
                flex-wrap: wrap;
            }
            
            .section-title::before {
                height: 24px;
            }
            
            .info-grid {
                grid-template-columns: 1fr;
                gap: 1.25rem;
            }
            
            .info-item label {
                font-size: 0.9rem;
            }
            
            .info-item input {
                padding: 0.85rem 1rem;
                font-size: 0.95rem;
            }
            
            .btn-primary {
                padding: 0.9rem 2rem;
                font-size: 0.95rem;
            }
            
            .order-card {
                padding: 1.5rem;
                border-radius: 12px;
            }
            
            .order-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.75rem;
            }
            
            .order-id {
                font-size: 1.05rem;
            }
            
            .order-status {
                padding: 0.5rem 1rem;
                font-size: 0.8rem;
            }
            
            .order-details {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }
            
            .order-detail-item {
                padding: 0.75rem;
            }
            
            .order-items h4 {
                font-size: 0.95rem;
            }
            
            .order-item {
                font-size: 0.9rem;
                padding: 0.6rem 0;
            }
            
            .address-grid {
                grid-template-columns: 1fr;
                gap: 1.25rem;
            }
            
            .address-card {
                padding: 1.5rem;
                border-radius: 12px;
            }
            
            .address-label {
                font-size: 0.8rem;
                padding: 0.4rem 0.85rem;
            }
            
            .address-name {
                font-size: 1rem;
            }
            
            .address-text {
                font-size: 0.9rem;
                line-height: 1.6;
            }
            
            .address-actions {
                margin-top: 1.25rem;
                padding-top: 1.25rem;
                gap: 0.5rem;
            }
            
            .address-actions button {
                padding: 0.65rem;
                font-size: 0.85rem;
            }
            
            .empty-state {
                padding: 4rem 1.5rem;
            }
            
            .empty-state i {
                font-size: 4rem;
            }
            
            .empty-state h3 {
                font-size: 1.3rem;
            }
            
            .empty-state p {
                font-size: 0.95rem;
            }
        }
        
        @media (max-width: 480px) {
            .page-hero {
                padding: 35px 0;
            }
            
            .page-hero h1 {
                font-size: 1.5rem;
                margin-bottom: 0.5rem;
            }
            
            .page-hero p {
                font-size: 0.9rem;
            }
            
            .profile-section {
                padding: 20px 0 160px;
                overflow-y: auto;
            }
            
            .profile-container {
                padding: 0 0.75rem;
            }
            
            .profile-sidebar {
                padding: 1.25rem;
            }
            
            .profile-avatar {
                width: 90px;
                height: 90px;
                font-size: 2.25rem;
                margin-bottom: 1.25rem;
            }
            
            .profile-name {
                font-size: 1.2rem;
            }
            
            .profile-phone {
                font-size: 0.85rem;
                margin-bottom: 1.25rem;
            }
            
            .profile-menu a {
                padding: 0.75rem 0.85rem;
                font-size: 0.9rem;
                gap: 0.75rem;
            }
            
            .profile-content {
                padding: 1.25rem;
            }
            
            .section-title {
                font-size: 1.25rem;
                margin-bottom: 1.25rem;
                gap: 0.5rem;
            }
            
            .section-title::before {
                width: 3px;
                height: 22px;
            }
            
            .info-grid {
                gap: 1rem;
            }
            
            .info-item input {
                padding: 0.75rem 0.9rem;
            }
            
            .btn-primary {
                padding: 0.85rem 1.75rem;
                font-size: 0.9rem;
            }
            
            .order-card {
                padding: 1.25rem;
            }
            
            .order-id {
                font-size: 1rem;
            }
            
            .order-status {
                padding: 0.45rem 0.9rem;
                font-size: 0.75rem;
            }
            
            .order-detail-item {
                padding: 0.65rem;
            }
            
            .order-detail-item label {
                font-size: 0.75rem;
            }
            
            .order-detail-item span {
                font-size: 0.95rem;
            }
            
            .order-items h4 {
                font-size: 0.9rem;
                margin-bottom: 0.75rem;
            }
            
            .order-item {
                font-size: 0.85rem;
                flex-direction: column;
                gap: 0.25rem;
                padding: 0.5rem 0;
            }
            
            .address-card {
                padding: 1.25rem;
            }
            
            .address-label {
                font-size: 0.75rem;
                padding: 0.35rem 0.75rem;
                margin-bottom: 1rem;
            }
            
            .address-name {
                font-size: 0.95rem;
                margin-bottom: 0.6rem;
            }
            
            .address-text {
                font-size: 0.85rem;
            }
            
            .address-actions {
                margin-top: 1rem;
                padding-top: 1rem;
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .address-actions button {
                width: 100%;
                padding: 0.7rem;
                font-size: 0.85rem;
            }
            
            .empty-state {
                padding: 3rem 1rem;
            }
            
            .empty-state i {
                font-size: 3.5rem;
                margin-bottom: 1.25rem;
            }
            
            .empty-state h3 {
                font-size: 1.15rem;
                margin-bottom: 0.5rem;
            }
            
            .empty-state p {
                font-size: 0.9rem;
                margin-bottom: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- reCAPTCHA Container (required for Firebase phone auth) -->
    <div id="recaptcha-container"></div>
    
    <div id="header-placeholder"></div>

    <!-- Page Hero -->
    <section class="page-hero">
        <div class="container">
            <h1>My Profile</h1>
            <p>Manage your account and view your orders</p>
        </div>
    </section>

    <!-- Profile Section -->
    <section class="profile-section">
        <div class="profile-container">
            <div class="profile-grid">
                <!-- Sidebar -->
                <aside class="profile-sidebar">
                    <div class="profile-avatar" id="profileAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="profile-name" id="profileName">Guest User</div>
                    <div class="profile-phone" id="profilePhone"><i class="fas fa-phone"></i> Not logged in</div>
                    <ul class="profile-menu">
                        <li><a href="#" class="active" onclick="showTab('info'); return false;"><i class="fas fa-user"></i> Profile Info</a></li>
                        <li><a href="#" onclick="showTab('orders'); return false;"><i class="fas fa-shopping-bag"></i> My Orders</a></li>
                        <li><a href="#" onclick="showTab('addresses'); return false;"><i class="fas fa-map-marker-alt"></i> Addresses</a></li>
                        <li><a href="#" onclick="signOut(); return false;"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                    </ul>
                </aside>

                <!-- Main Content -->
                <main class="profile-content">
                    <!-- Profile Info Tab -->
                    <div id="infoTab" class="tab-content">
                        <h2 class="section-title"><i class="fas fa-user-circle"></i> Profile Information</h2>
                        <form id="updateProfileForm">
                            <div class="info-grid">
                                <div class="info-item">
                                    <label><i class="fas fa-user"></i> Full Name</label>
                                    <input type="text" id="fullName" placeholder="Enter your full name">
                                </div>
                                <div class="info-item">
                                    <label><i class="fas fa-envelope"></i> Email</label>
                                    <input type="email" id="email" placeholder="your.email@example.com">
                                </div>
                                <div class="info-item">
                                    <label><i class="fas fa-phone"></i> Phone Number</label>
                                    <input type="tel" id="phone" readonly>
                                </div>
                                <div class="info-item">
                                    <label><i class="fas fa-calendar-alt"></i> Member Since</label>
                                    <input type="text" id="memberSince" readonly>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Update Profile
                            </button>
                        </form>
                    </div>

                    <!-- Orders Tab -->
                    <div id="ordersTab" class="tab-content" style="display: none;">
                        <h2 class="section-title"><i class="fas fa-shopping-bag"></i> My Orders</h2>
                        <div class="orders-list" id="ordersList">
                            <div class="empty-state">
                                <i class="fas fa-box-open"></i>
                                <h3>No orders yet</h3>
                                <p>Your order history will appear here</p>
                                <a href="shop.html" class="btn btn-primary" style="margin-top: 1rem;"><i class="fas fa-store"></i> Start Shopping</a>
                            </div>
                        </div>
                    </div>

                    <!-- Addresses Tab -->
                    <div id="addressesTab" class="tab-content" style="display: none;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
                            <h2 class="section-title" style="margin: 0; border: none; padding: 0;"><i class="fas fa-map-marker-alt"></i> My Addresses</h2>
                            <button class="btn btn-primary" onclick="showAddAddressForm()">
                                <i class="fas fa-plus"></i> Add Address
                            </button>
                        </div>
                        <div class="address-grid" id="addressesGrid">
                            <div class="empty-state">
                                <i class="fas fa-map-marker-alt"></i>
                                <h3>No addresses saved</h3>
                                <p>Add your delivery addresses for faster checkout</p>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </section>

    <div id="footer-placeholder"></div>

    <!-- BOTTOM NAV (mobile) -->
    <div class="bottom-nav">
        <a href="index.html" class="bottom-nav-item mobile-nav-item">
            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
            Home
        </a>
        <a href="shop.html" class="bottom-nav-item mobile-nav-item">
            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
            Menu
        </a>
        <a href="#" class="bottom-nav-cart-wrap" id="cartIconBottom">
            <div class="bottom-nav-cart">
                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>
            </div>
            <span class="bottom-nav-cart-label">Cart <span class="cart-count-badge" id="cartCountMobile">0</span></span>
        </a>
        <a href="tracking.html" class="bottom-nav-item mobile-nav-item">
            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>
            Tracking
        </a>
        <a href="profile.html" class="bottom-nav-item mobile-nav-item active">
            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
            Log In
        </a>
    </div>

    <!-- Mobile User Menu Dropdown -->
    <div class="mobile-user-dropdown" id="mobileUserDropdown">
        <a href="profile.html">
            <i class="fas fa-user"></i> My Profile
        </a>
        <a href="profile.html?tab=addresses">
            <i class="fas fa-map-marker-alt"></i> My Addresses
        </a>
        <a href="profile.html?tab=orders">
            <i class="fas fa-shopping-bag"></i> My Orders
        </a>
        <a href="#" onclick="signOut(); return false;">
            <i class="fas fa-sign-out-alt"></i> Sign Out
        </a>
    </div>

    <!-- Cart Modal -->
    <div class="cart-modal" id="cartModal">
        <div class="cart-overlay" id="cartOverlay"></div>
        <div class="cart-drawer">
            <div class="cart-header">
                <h3><i class="fas fa-shopping-cart"></i> Shopping Cart</h3>
                <button class="cart-close" id="cartClose">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="cart-items" id="cartItems"></div>
            <div class="cart-footer">
                <div class="cart-total">
                    <span>Total:</span>
                    <span id="cartTotal">0.00 AED</span>
                </div>
                <button class="btn btn-primary btn-block" onclick="proceedToCheckout()">
                    Proceed to Checkout <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- App JS -->
    <script src="app.js"></script>
    
    <!-- Authentication JS -->
    <script src="auth.js"></script>

    <!-- Authentication Modals -->
    <div class="auth-modal" id="authModal"></div>
    <div class="profile-modal" id="profileModal" style="display: none;"></div>
    
    <!-- Addresses Modal -->
    <div class="addresses-modal" id="addressesModal" style="display: none;">
        <div class="auth-overlay" onclick="closeAddressesModal()"></div>
        <div class="addresses-container">
            <button class="auth-close" onclick="closeAddressesModal()"><i class="fas fa-times"></i></button>
            <div class="addresses-header">
                <h2><i class="fas fa-map-marker-alt"></i> My Addresses</h2>
                <button class="btn btn-primary" onclick="showAddAddressForm()"><i class="fas fa-plus"></i> Add New</button>
            </div>
            <div class="addresses-list" id="addressesList"></div>
            <div class="address-form-container" id="addressFormContainer" style="display: none;">
                <h3 id="addressFormTitle">Add New Address</h3>
                <form class="address-form" id="addressForm">
                    <input type="hidden" id="addressId" />
                    <div class="form-row">
                        <div class="form-group">
                            <label>Label</label>
                            <select id="addressLabel" required>
                                <option value="Home">Home</option>
                                <option value="Work">Work</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Full Name</label>
                            <input type="text" id="addressFullName" required />
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Phone Number</label>
                            <input type="tel" id="addressPhone" required />
                        </div>
                        <div class="form-group">
                            <label>Area</label>
                            <input type="text" id="addressArea" required />
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Street Address <small>(Drag the marker or click "Use My Location" on map)</small></label>
                        <input type="text" id="addressStreet" required placeholder="Address will be filled from map..." />
                        
                        <!-- Saved Address Quick-Select Buttons -->
                        <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap;">
                            <div id="savedAddressButtons" style="display: flex; gap: 0.5rem; flex-wrap: wrap; width: 100%;"></div>
                        </div>
                        
                        <div id="addressMap" style="width: 100%; height: 400px; border-radius: 8px; margin-top: 0.5rem; border: 2px solid var(--border);"></div>
                        <small style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 0.5rem; display: block;">
                            <i class="fas fa-info-circle"></i> Click "Use My Location" button on map, drag marker, or click anywhere on the map
                        </small>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Building</label>
                            <input type="text" id="addressBuilding" />
                        </div>
                        <div class="form-group">
                            <label>Floor</label>
                            <input type="text" id="addressFloor" />
                        </div>
                        <div class="form-group">
                            <label>Apartment</label>
                            <input type="text" id="addressApartment" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Landmark (Optional)</label>
                        <input type="text" id="addressLandmark" />
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="addressDefault" />
                            Set as default address
                        </label>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-outline" onclick="hideAddressForm()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Address</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Check if user is logged in
        async function checkAuth() {
            if (!window.getCurrentUser || !window.getCurrentUser()) {
                window.location.href = 'index.html?login=required';
                return false;
            }
            return true;
        }

        // Load user profile data
        async function loadUserData() {
            const user = window.getCurrentUser ? window.getCurrentUser() : null;
            const profile = window.getUserProfile ? window.getUserProfile() : null;
            
            if (!user) {
                await checkAuth();
                return;
            }

            // Update sidebar
            document.getElementById('profileName').textContent = profile?.full_name || 'Guest User';
            document.getElementById('profilePhone').textContent = profile?.phone_number || user.phoneNumber || 'No phone';
            
            // Update profile avatar
            const initials = (profile?.full_name || 'G').split(' ').map(n => n[0]).join('').toUpperCase();
            document.getElementById('profileAvatar').innerHTML = initials;

            // Update form fields
            document.getElementById('fullName').value = profile?.full_name || '';
            document.getElementById('email').value = profile?.email || '';
            document.getElementById('phone').value = profile?.phone_number || user.phoneNumber || '';
            
            // Format member since date
            const memberSince = profile?.created_at ? new Date(profile.created_at).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            }) : 'Recently';
            document.getElementById('memberSince').value = memberSince;

            // Load orders
            await loadUserOrders();
            
            // Load addresses
            await loadUserAddressesTab();
        }

        // Load user orders
        async function loadUserOrders() {
            const ordersList = document.getElementById('ordersList');
            const user = window.getCurrentUser ? window.getCurrentUser() : null;
            
            if (!user) return;

            try {
                const { data: orders, error } = await supabase
                    .from('orders')
                    .select('*')
                    .eq('user_id', user.uid)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                if (orders && orders.length > 0) {
                    ordersList.innerHTML = orders.map(order => {
                        const statusClass = `status-${(order.status || 'pending').toLowerCase()}`;
                        const items = order.items ? JSON.parse(order.items) : [];
                        // Convert order.id to string to handle UUID
                        const orderId = String(order.id || '').substring(0, 8);
                        
                        return `
                            <div class="order-card">
                                <div class="order-header">
                                    <div class="order-id"><i class="fas fa-receipt"></i> #${orderId}</div>
                                    <div class="order-status ${statusClass}">${order.status || 'Pending'}</div>
                                </div>
                                <div class="order-details">
                                    <div class="order-detail-item">
                                        <label><i class="fas fa-calendar"></i> Order Date</label>
                                        <span>${new Date(order.created_at).toLocaleDateString()}</span>
                                    </div>
                                    <div class="order-detail-item">
                                        <label><i class="fas fa-money-bill-wave"></i> Total Amount</label>
                                        <span>${(order.total_amount || 0).toFixed(2)} AED</span>
                                    </div>
                                    <div class="order-detail-item">
                                        <label><i class="fas fa-credit-card"></i> Payment</label>
                                        <span>${order.payment_method === 'cod' ? 'Cash on Delivery' : 'Card'}</span>
                                    </div>
                                </div>
                                <div class="order-items">
                                    <h4><i class="fas fa-shopping-basket"></i> Items (${items.length})</h4>
                                    ${items.map(item => `
                                        <div class="order-item">
                                            <span><i class="fas fa-check-circle" style="color: var(--profile-accent); margin-right: 0.5rem;"></i>${item.name} (${item.quantity} ${item.unit || 'pcs'})</span>
                                            <span style="font-weight: 600; color: var(--text-primary);">${(item.price * item.quantity).toFixed(2)} AED</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    ordersList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-box-open"></i>
                            <h3>No orders yet</h3>
                            <p>Your order history will appear here</p>
                            <a href="shop.html" class="btn btn-primary" style="margin-top: 1rem;"><i class="fas fa-store"></i> Start Shopping</a>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading orders:', error);
                showNotification('Failed to load orders', 'error');
            }
        }

        // Load user addresses for the tab
        async function loadUserAddressesTab() {
            const addressesGrid = document.getElementById('addressesGrid');
            const addresses = window.getUserAddresses ? window.getUserAddresses() : [];
            
            if (!addresses || addresses.length === 0) {
                addressesGrid.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-map-marker-alt"></i>
                        <h3>No addresses saved</h3>
                        <p>Add your delivery addresses for faster checkout</p>
                    </div>
                `;
                return;
            }

            addressesGrid.innerHTML = addresses.map(addr => `
                <div class="address-card ${addr.is_default ? 'default' : ''}">
                    <div class="address-label"><i class="fas fa-${addr.label === 'Home' ? 'home' : addr.label === 'Work' ? 'briefcase' : 'map-marker-alt'}"></i> ${addr.label || 'Home'}${addr.is_default ? ' (Default)' : ''}</div>
                    <div class="address-name"><i class="fas fa-user" style="color: var(--profile-accent); margin-right: 0.5rem;"></i>${addr.full_name}</div>
                    <div class="address-text">
                        <i class="fas fa-phone" style="color: var(--profile-accent); margin-right: 0.5rem;"></i>${addr.phone_number}<br>
                        <i class="fas fa-location-dot" style="color: var(--profile-accent); margin-right: 0.5rem;"></i>${addr.street_address}<br>
                        ${[addr.building, addr.floor, addr.apartment].filter(Boolean).join(', ')}<br>
                        <i class="fas fa-map" style="color: var(--profile-accent); margin-right: 0.5rem;"></i>${addr.area}
                        ${addr.landmark ? '<br><i class="fas fa-landmark" style="color: var(--profile-accent); margin-right: 0.5rem;"></i>Landmark: ' + addr.landmark : ''}
                    </div>
                    <div class="address-actions">
                        <button class="btn-edit" onclick="editAddress('${addr.id}')">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn-delete" onclick="confirmDeleteAddress('${addr.id}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Tab switching
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
            
            // Show selected tab
            document.getElementById(tabName + 'Tab').style.display = 'block';
            
            // Update active menu item
            document.querySelectorAll('.profile-menu a').forEach(link => link.classList.remove('active'));
            // Find the link that was clicked by matching the onclick attribute
            const activeLink = document.querySelector(`.profile-menu a[onclick*="showTab('${tabName}')"]`);
            if (activeLink) activeLink.classList.add('active');
            
            // Load addresses when addresses tab is shown
            if (tabName === 'addresses') {
                loadUserAddressesTab();
            }
        }

        // Update profile form submission
        document.getElementById('updateProfileForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const fullName = document.getElementById('fullName').value;
            const email = document.getElementById('email').value;
            
            try {
                await updateUserProfile({ full_name: fullName, email: email });
                showNotification('Profile updated successfully!', 'success');
                // Reload user data to update sidebar
                await loadUserData();
            } catch (error) {
                console.error('Error updating profile:', error);
                showNotification('Failed to update profile', 'error');
            }
        });
        
        // Note: Address form submission is handled in auth.js to avoid duplicate submissions
        // DO NOT add another listener here
        
        // Close addresses modal
        function closeAddressesModal() {
            const modal = document.getElementById('addressesModal');
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = '';
            }
            // Reset form view
            hideAddressForm();
        }
        
        // Hide address form and show addresses list
        function hideAddressForm() {
            const addressesList = document.getElementById('addressesList');
            const formContainer = document.getElementById('addressFormContainer');
            
            if (addressesList) addressesList.style.display = 'block';
            if (formContainer) formContainer.style.display = 'none';
            
            // Clear form
            const form = document.getElementById('addressForm');
            if (form) form.reset();
            document.getElementById('addressId').value = '';
        }
        
        // Edit address
        async function editAddress(addressId) {
            const addresses = window.getUserAddresses ? window.getUserAddresses() : [];
            const address = addresses.find(a => a.id === addressId);
            
            if (!address) {
                showNotification('Address not found', 'error');
                return;
            }
            
            // Open modal and show form
            const modal = document.getElementById('addressesModal');
            if (modal) {
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }
            
            const addressesList = document.getElementById('addressesList');
            const formContainer = document.getElementById('addressFormContainer');
            const formTitle = document.getElementById('addressFormTitle');
            
            if (addressesList) addressesList.style.display = 'none';
            if (formContainer) formContainer.style.display = 'block';
            if (formTitle) formTitle.textContent = 'Edit Address';
            
            // Fill form with address data
            document.getElementById('addressId').value = address.id;
            document.getElementById('addressLabel').value = address.label || 'Home';
            document.getElementById('addressFullName').value = address.full_name || '';
            document.getElementById('addressPhone').value = address.phone_number || '';
            document.getElementById('addressArea').value = address.area || '';
            document.getElementById('addressStreet').value = address.street_address || '';
            document.getElementById('addressBuilding').value = address.building || '';
            document.getElementById('addressFloor').value = address.floor || '';
            document.getElementById('addressApartment').value = address.apartment || '';
            document.getElementById('addressLandmark').value = address.landmark || '';
            document.getElementById('addressDefault').checked = address.is_default || false;
        }
        
        // Confirm delete address
        function confirmDeleteAddress(addressId) {
            if (confirm('Are you sure you want to delete this address? This action cannot be undone.')) {
                deleteAddress(addressId);
            }
        }
        
        // Delete address
        async function deleteAddress(addressId) {
            const user = window.getCurrentUser ? window.getCurrentUser() : null;
            if (!user) return;
            
            try {
                const { error } = await supabase
                    .from('user_addresses')
                    .delete()
                    .eq('id', addressId)
                    .eq('user_id', user.uid);
                
                if (error) throw error;
                
                showNotification('Address deleted successfully', 'success');
                
                // Reload addresses in auth.js cache
                if (window.loadUserAddresses) {
                    await window.loadUserAddresses();
                }
                
                // Refresh the addresses grid AND the map buttons
                await loadUserAddressesTab();
                loadSavedAddressButtons();
            } catch (error) {
                console.error('Error deleting address:', error);
                showNotification('Failed to delete address', 'error');
            }
        }
        
        // Function to show add address form directly (without showing addresses list first)
        function showAddAddressForm() {
            // Open the addresses modal
            const modal = document.getElementById('addressesModal');
            if (modal) {
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }
            
            // Hide the addresses list and show the form immediately
            const addressesList = document.getElementById('addressesList');
            const formContainer = document.getElementById('addressFormContainer');
            const formTitle = document.getElementById('addressFormTitle');
            
            if (addressesList) addressesList.style.display = 'none';
            if (formContainer) {
                formContainer.style.display = 'block';
                if (formTitle) formTitle.textContent = 'Add New Address';
                
                // Clear form
                const form = document.getElementById('addressForm');
                if (form) form.reset();
                document.getElementById('addressId').value = '';
                
                // Focus first input
                setTimeout(() => {
                    const firstInput = document.getElementById('addressLabel');
                    if (firstInput) firstInput.focus();
                }, 100);
            }
        }

        // Initialize page
        window.addEventListener('load', async () => {
            // Initialize header-dependent features after header loads
            function initializeHeaderFeatures() {
                // Setup cart button (desktop & mobile)
                const cartBtn = document.getElementById('cartBtn');
                const cartNavBtn = document.getElementById('cartNavBtn');
                const cartModal = document.getElementById('cartModal');
                const cartClose = document.getElementById('cartClose');
                const cartOverlay = document.getElementById('cartOverlay');
                
                function openCart() {
                    if (cartModal) {
                        cartModal.classList.add('active');
                        document.body.style.overflow = 'hidden';
                        // Display cart if function exists
                        if (typeof displayCart === 'function') displayCart();
                    }
                }
                
                function closeCart() {
                    if (cartModal) {
                        cartModal.classList.remove('active');
                        document.body.style.overflow = '';
                    }
                }
                
                if (cartBtn) cartBtn.addEventListener('click', openCart);
                if (cartNavBtn) cartNavBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    openCart();
                });
                if (cartClose) cartClose.addEventListener('click', closeCart);
                if (cartOverlay) cartOverlay.addEventListener('click', closeCart);

                // Mobile menu toggle
                const mobileMenuBtn = document.getElementById('mobileMenuBtn');
                const navMenu = document.getElementById('navMenu');
                if (mobileMenuBtn && navMenu) {
                    mobileMenuBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        navMenu.classList.toggle('active');
                        this.classList.toggle('active');
                    });
                    document.addEventListener('click', function(e) {
                        if (!navMenu.contains(e.target) && !mobileMenuBtn.contains(e.target)) {
                            navMenu.classList.remove('active');
                            mobileMenuBtn.classList.remove('active');
                        }
                    });
                }

                // Header scroll effect
                window.addEventListener('scroll', function() {
                    const header = document.getElementById('header');
                    if (header) header.classList.toggle('scrolled', window.scrollY > 50);
                });
            }

            // Wait for header to load before initializing
            window.addEventListener('headerLoaded', initializeHeaderFeatures);
            
            // Wait for auth to initialize
            await waitForAuth();
            await loadUserData();
            
            // Check for URL parameters to switch tabs
            const urlParams = new URLSearchParams(window.location.search);
            const tab = urlParams.get('tab');
            if (tab) {
                showTab(tab);
            }
            
            // Register callback for address updates (called by auth.js after save)
            window.onAddressUpdated = function() {
                console.log('Address updated, refreshing UI...');
                loadUserAddressesTab(); // Refresh addresses grid
                loadSavedAddressButtons(); // Refresh quick-select buttons
            };
            
            // Initialize Google Maps Autocomplete after a short delay
            setTimeout(initializeAddressAutocomplete, 1000);
        });
        
        // Initialize Google Maps with draggable marker
        let addressMap, addressMarker; // Make global so buttons can access
        
        function initializeAddressAutocomplete() {
            if (typeof google === 'undefined' || !google.maps) {
                console.log('Google Maps not loaded yet, will retry...');
                setTimeout(initializeAddressAutocomplete, 1000);
                return;
            }
            
            const mapDiv = document.getElementById('addressMap');
            if (!mapDiv) return;
            
            // Default to Dubai coordinates
            const defaultLocation = { lat: 25.2048, lng: 55.2708 };
            
            // Create the map with geolocation control
            addressMap = new google.maps.Map(mapDiv, {
                center: defaultLocation,
                zoom: 13,
                mapTypeControl: false,
                streetViewControl: false,
                fullscreenControl: true,
                zoomControl: true,
                zoomControlOptions: {
                    position: google.maps.ControlPosition.RIGHT_CENTER
                }
            });
            
            // Add Google's native geolocation control button
            const locationButton = document.createElement('button');
            locationButton.textContent = 'Use My Location';
            locationButton.classList.add('btn', 'btn-primary');
            locationButton.style.margin = '10px';
            locationButton.style.fontSize = '14px';
            locationButton.style.padding = '8px 16px';
            
            addressMap.controls[google.maps.ControlPosition.TOP_CENTER].push(locationButton);
            
            locationButton.addEventListener('click', () => {
                if (navigator.geolocation) {
                    locationButton.textContent = 'Locating...';
                    locationButton.disabled = true;
                    
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const pos = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            };
                            
                            addressMap.setCenter(pos);
                            addressMarker.setPosition(pos);
                            
                            // Try to geocode
                            const geocoder = new google.maps.Geocoder();
                            geocoder.geocode({ location: pos }, (results, status) => {
                                console.log('Geocoding status:', status);
                                console.log('Geocoding results:', results);
                                
                                if (status === 'OK' && results[0]) {
                                    document.getElementById('addressStreet').value = results[0].formatted_address;
                                    
                                    // Try to extract area
                                    for (const component of results[0].address_components) {
                                        const types = component.types;
                                        if (types.includes('sublocality_level_1') || types.includes('neighborhood') || types.includes('locality')) {
                                            const areaInput = document.getElementById('addressArea');
                                            if (areaInput && !areaInput.value) {
                                                areaInput.value = component.long_name;
                                                break;
                                            }
                                        }
                                    }
                                } else if (status === 'REQUEST_DENIED') {
                                    console.error(' Geocoding API ERROR:', status);
                                    console.error('This usually means:');
                                    console.error('1. Your API key has HTTP referrer restrictions');
                                    console.error('2. Geocoding API is not enabled for THIS specific API key');
                                    console.error('3. Billing is not enabled on your Google Cloud project');
                                    console.error('\nCheck: https://console.cloud.google.com/google/maps-apis/credentials');
                                    alert(' Geocoding API Access Denied\n\nYour API key cannot access Geocoding API.\n\nPossible causes:\n API key has referrer restrictions\n Geocoding API not enabled for this key\n Billing not enabled\n\nCheck browser console for details.');
                                    document.getElementById('addressStreet').value = `Lat: ${pos.lat.toFixed(6)}, Lng: ${pos.lng.toFixed(6)}`;
                                } else {
                                    console.warn('Geocoding failed with status:', status);
                                    document.getElementById('addressStreet').value = `Lat: ${pos.lat.toFixed(6)}, Lng: ${pos.lng.toFixed(6)} (${status})`;
                                }
                            });
                            
                            locationButton.textContent = 'Use My Location';
                            locationButton.disabled = false;
                        },
                        () => {
                            alert('Error: Could not get your location. Please enable location permissions.');
                            locationButton.textContent = 'Use My Location';
                            locationButton.disabled = false;
                        }
                    );
                } else {
                    alert('Error: Your browser does not support geolocation.');
                }
            });
            
            // Create a draggable marker
            addressMarker = new google.maps.Marker({
                position: defaultLocation,
                map: addressMap,
                draggable: true,
                animation: google.maps.Animation.DROP,
                title: 'Drag me to your location'
            });
            
            // Geocoder for reverse geocoding (OPTIONAL - may not be enabled in API)
            const geocoder = new google.maps.Geocoder();
            
            // Function to update address from coordinates
            function updateAddressFromLocation(lat, lng) {
                // Try geocoding, but don't fail if API is not enabled
                geocoder.geocode({ location: { lat, lng } }, (results, status) => {
                    console.log('Drag geocoding status:', status);
                    
                    if (status === 'OK' && results[0]) {
                        console.log('Geocode results:', results[0]);
                        
                        // Extract address components
                        let streetNumber = '';
                        let route = '';
                        let area = '';
                        let city = '';
                        
                        for (const component of results[0].address_components) {
                            const types = component.types;
                            
                            if (types.includes('street_number')) {
                                streetNumber = component.long_name;
                            }
                            if (types.includes('route')) {
                                route = component.long_name;
                            }
                            if (types.includes('sublocality_level_1') || types.includes('neighborhood')) {
                                area = component.long_name;
                            }
                            if (types.includes('locality')) {
                                city = component.long_name;
                            }
                        }
                        
                        // Auto-fill the street address
                        const streetAddress = [streetNumber, route].filter(Boolean).join(' ') || results[0].formatted_address;
                        document.getElementById('addressStreet').value = streetAddress;
                        
                        // Auto-fill the area if found
                        if (area || city) {
                            const areaInput = document.getElementById('addressArea');
                            if (areaInput && !areaInput.value) {
                                areaInput.value = area || city;
                            }
                        }
                        
                        console.log('Address updated:', streetAddress, 'Area:', area || city);
                    } else if (status === 'REQUEST_DENIED') {
                        console.error(' Geocoding API REQUEST_DENIED');
                        console.error('Check: https://console.cloud.google.com/google/maps-apis/credentials');
                        console.error('Ensure Geocoding API is enabled for key: AIzaSyAqs6k9yZisdszgk-eUYZIryRyRSEgVR6M');
                        // Show coordinates as fallback
                        document.getElementById('addressStreet').value = `Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)} (API Key Error)`;
                    } else {
                        console.warn('Geocoder status:', status);
                        document.getElementById('addressStreet').value = `Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)} (${status})`;
                    }
                });
            }
            
            // Update address when marker is dragged
            addressMarker.addListener('dragend', function() {
                const position = addressMarker.getPosition();
                updateAddressFromLocation(position.lat(), position.lng());
            });
            
            // Don't auto-locate on page load, let user click button instead
            
            // Add click on map to move marker
            addressMap.addListener('click', function(event) {
                addressMarker.setPosition(event.latLng);
                updateAddressFromLocation(event.latLng.lat(), event.latLng.lng());
            });
            
            // Load saved address quick-select buttons
            loadSavedAddressButtons();
        }
        
        // Load saved address buttons for quick selection
        function loadSavedAddressButtons() {
            const container = document.getElementById('savedAddressButtons');
            if (!container) {
                console.log('savedAddressButtons container not found');
                return;
            }
            
            const addresses = window.getUserAddresses ? window.getUserAddresses() : [];
            console.log('loadSavedAddressButtons (profile) - Addresses:', addresses);
            
            if (addresses && addresses.length > 0) {
                container.innerHTML = addresses.map(addr => `
                    <button type="button" class="btn btn-outline" onclick="selectSavedAddressForMap('${addr.id}')" style="font-size: 0.85rem; padding: 0.4rem 0.8rem;">
                        <i class="fas fa-map-pin"></i> ${addr.label || 'Home'}
                    </button>
                `).join('');
            } else {
                container.innerHTML = '<small style="color: var(--text-secondary); align-self: center;">No saved addresses yet</small>';
            }
        }
        
        // Select a saved address and move map to it
        function selectSavedAddressForMap(addressId) {
            const addresses = window.getUserAddresses ? window.getUserAddresses() : [];
            const address = addresses.find(a => a.id === addressId);
            
            if (!address) return;
            
            // Fill form fields
            document.getElementById('addressStreet').value = address.street_address || '';
            document.getElementById('addressArea').value = address.area || '';
            document.getElementById('addressBuilding').value = address.building || '';
            document.getElementById('addressFloor').value = address.floor || '';
            document.getElementById('addressApartment').value = address.apartment || '';
            document.getElementById('addressLandmark').value = address.landmark || '';
            
            // Note: We can't geocode the address to get coordinates without the Geocoding API
            // User can still see the form is filled and adjust the marker manually if needed
            alert(`Address loaded: ${address.street_address}\\nDrag the map marker to your exact location.`);
        }
        
        // Wait for auth to be ready
        async function waitForAuth() {
            return new Promise((resolve) => {
                let attempts = 0;
                const checkAuth = setInterval(() => {
                    attempts++;
                    
                    // Check if Firebase is ready
                    if (typeof firebase !== 'undefined' && firebase.auth) {
                        const firebaseUser = firebase.auth().currentUser;
                        
                        // If no Firebase user, redirect to login
                        if (!firebaseUser && attempts > 10) {
                            clearInterval(checkAuth);
                            console.log('No user logged in - redirecting');
                            window.location.href = 'index.html?login=required';
                            resolve();
                            return;
                        }
                        
                        // If Firebase user exists, wait for profile to sync
                        if (firebaseUser) {
                            const user = window.getCurrentUser ? window.getCurrentUser() : null;
                            const profile = window.getUserProfile ? window.getUserProfile() : null;
                            
                            // Profile is loaded, we're ready
                            if (user && profile) {
                                clearInterval(checkAuth);
                                console.log('Auth ready with profile:', profile);
                                resolve();
                                return;
                            }
                        }
                    }
                    
                    // Timeout after 5 seconds
                    if (attempts > 50) {
                        clearInterval(checkAuth);
                        console.log('Auth wait timeout');
                        resolve();
                    }
                }, 100);
            });
        }
    </script>
</body>
</html>
