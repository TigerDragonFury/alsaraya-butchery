<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles2.css">
    <title>My Profile - Al Saraya Butchery</title>
    <link rel="icon" type="image/png" href="https://i.imgur.com/gWdOYdW.png">
    
    <!-- Supabase (for database) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Firebase (for FREE phone authentication) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="firebase-config.js"></script>
    
    <!-- Google Maps Places API (for address autocomplete) -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAqs6k9yZisdszgk-eUYZIryRyRSEgVR6M&libraries=places" async defer></script>
    
    <style>
        .page-hero {
            margin-top: 115px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 60px 0;
            text-align: center;
            color: var(--white);
        }
        .page-hero h1 {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
        }
        .profile-section {
            padding: 60px 0 80px;
            background: var(--light);
            min-height: 60vh;
        }
        .profile-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }
        .profile-grid {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 2rem;
            margin-top: 2rem;
        }
        .profile-sidebar {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: 2rem;
            box-shadow: var(--shadow);
            height: fit-content;
        }
        .profile-avatar {
            width: 120px;
            height: 120px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: 3rem;
            margin: 0 auto 1.5rem;
        }
        .profile-name {
            text-align: center;
            margin-bottom: 0.5rem;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        .profile-phone {
            text-align: center;
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
            font-size: 0.95rem;
        }
        .profile-menu {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .profile-menu li {
            margin-bottom: 0.5rem;
        }
        .profile-menu a {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            color: var(--text-primary);
            text-decoration: none;
            border-radius: var(--radius);
            transition: var(--transition);
        }
        .profile-menu a:hover,
        .profile-menu a.active {
            background: var(--primary-light);
            color: var(--primary);
        }
        .profile-menu i {
            width: 20px;
            text-align: center;
        }
        .profile-content {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: 2rem;
            box-shadow: var(--shadow);
        }
        .section-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: var(--text-primary);
        }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .info-item label {
            display: block;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        .info-item input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--gray-200);
            border-radius: var(--radius);
            font-size: 1rem;
            transition: var(--transition);
        }
        .info-item input:focus {
            outline: none;
            border-color: var(--primary);
        }
        .orders-list {
            margin-top: 2rem;
        }
        .order-card {
            background: var(--light);
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: var(--transition);
        }
        .order-card:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow);
        }
        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--gray-200);
        }
        .order-id {
            font-weight: 700;
            color: var(--text-primary);
            font-size: 1.1rem;
        }
        .order-status {
            padding: 0.5rem 1rem;
            border-radius: 50px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        .status-pending { background: #FEF3C7; color: #92400E; }
        .status-confirmed { background: #DBEAFE; color: #1E40AF; }
        .status-processing { background: #E0E7FF; color: #4338CA; }
        .status-delivered { background: #D1FAE5; color: #065F46; }
        .status-cancelled { background: #FEE2E2; color: #991B1B; }
        .order-details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .order-detail-item {
            display: flex;
            flex-direction: column;
        }
        .order-detail-item label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }
        .order-detail-item span {
            font-weight: 600;
            color: var(--text-primary);
        }
        .order-items {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--gray-200);
        }
        .order-items h4 {
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--text-primary);
        }
        .order-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-secondary);
        }
        .empty-state i {
            font-size: 4rem;
            color: var(--gray-300);
            margin-bottom: 1rem;
        }
        .empty-state h3 {
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }
        .address-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }
        .address-card {
            background: var(--light);
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            position: relative;
        }
        .address-card.default {
            border-color: var(--primary);
        }
        .address-label {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: var(--primary);
            color: var(--white);
            border-radius: 50px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }
        .address-card.default .address-label {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
        }
        .address-name {
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }
        .address-text {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.5;
            margin-bottom: 0.5rem;
        }
        .address-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        .address-actions button {
            flex: 1;
            padding: 0.5rem;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: var(--transition);
        }
        .btn-edit {
            background: var(--primary-light);
            color: var(--primary);
        }
        .btn-edit:hover {
            background: var(--primary);
            color: var(--white);
        }
        .btn-delete {
            background: #FEE2E2;
            color: #991B1B;
        }
        .btn-delete:hover {
            background: #991B1B;
            color: var(--white);
        }
        @media (max-width: 768px) {
            .page-hero {
                margin-top: 70px;
                padding: 40px 0;
            }
            .profile-grid {
                grid-template-columns: 1fr;
            }
            .info-grid {
                grid-template-columns: 1fr;
            }
            .order-details {
                grid-template-columns: 1fr;
            }
            .profile-section {
                padding: 30px 0 120px;
            }
        }
    </style>
</head>
<body>
    <!-- reCAPTCHA Container (required for Firebase phone auth) -->
    <div id="recaptcha-container"></div>
    
    <!-- Header -->
    <header class="header" id="header">
        <div class="header-top">
            <div class="container">
                <div class="header-top-content">
                    <div class="header-contact">
                        <a href="tel:+97123339111"><i class="fas fa-phone"></i> (02) 333 9111</a>
                        <span class="divider">|</span>
                        <a href="mailto:info@alsarayabutchery.com"><i class="fas fa-envelope"></i> info@alsarayabutchery.com</a>
                    </div>
                    <div class="header-social">
                        <a href="#"><i class="fab fa-facebook-f"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                        <a href="#"><i class="fab fa-whatsapp"></i></a>
                    </div>
                </div>
            </div>
        </div>
        <div class="header-main">
            <div class="container">
                <div class="header-main-content">
                    <a href="index.html" class="logo">
                        <img src="https://i.imgur.com/3PRDEK0.png" alt="Al Saraya">
                    </a>
                    <nav class="nav-menu" id="navMenu">
                        <ul>
                            <li><a href="index.html">Home</a></li>
                            <li><a href="shop.html">Shop</a></li>
                            <li><a href="index.html#categories">Categories</a></li>
                            <li><a href="index.html#popular">Popular</a></li>
                            <li><a href="tracking.html">Track Order</a></li>
                            <li><a href="index.html#contact">Contact</a></li>
                        </ul>
                    </nav>
                    <div class="header-actions">
                        <button class="cart-btn" id="cartBtn">
                            <i class="fas fa-shopping-cart"></i>
                            <span class="cart-count" id="cartCount">0</span>
                        </button>
                        <div id="authBtnContainer">
                            <button class="btn-auth" onclick="openAuthModal('login')">
                                <i class="fas fa-user"></i> Login
                            </button>
                        </div>
                        <button class="mobile-menu-btn" id="mobileMenuBtn">
                            <span></span>
                            <span></span>
                            <span></span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Page Hero -->
    <section class="page-hero">
        <div class="container">
            <h1>My Profile</h1>
            <p>Manage your account and view your orders</p>
        </div>
    </section>

    <!-- Profile Section -->
    <section class="profile-section">
        <div class="profile-container">
            <div class="profile-grid">
                <!-- Sidebar -->
                <aside class="profile-sidebar">
                    <div class="profile-avatar" id="profileAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="profile-name" id="profileName">Guest User</div>
                    <div class="profile-phone" id="profilePhone">Not logged in</div>
                    <ul class="profile-menu">
                        <li><a href="#" class="active" onclick="showTab('info'); return false;"><i class="fas fa-user"></i> Profile Info</a></li>
                        <li><a href="#" onclick="showTab('orders'); return false;"><i class="fas fa-shopping-bag"></i> My Orders</a></li>
                        <li><a href="#" onclick="showTab('addresses'); return false;"><i class="fas fa-map-marker-alt"></i> Addresses</a></li>
                        <li><a href="#" onclick="signOut(); return false;"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                    </ul>
                </aside>

                <!-- Main Content -->
                <main class="profile-content">
                    <!-- Profile Info Tab -->
                    <div id="infoTab" class="tab-content">
                        <h2 class="section-title">Profile Information</h2>
                        <form id="updateProfileForm">
                            <div class="info-grid">
                                <div class="info-item">
                                    <label>Full Name</label>
                                    <input type="text" id="fullName" placeholder="Enter your full name">
                                </div>
                                <div class="info-item">
                                    <label>Email</label>
                                    <input type="email" id="email" placeholder="your.email@example.com">
                                </div>
                                <div class="info-item">
                                    <label>Phone Number</label>
                                    <input type="tel" id="phone" readonly>
                                </div>
                                <div class="info-item">
                                    <label>Member Since</label>
                                    <input type="text" id="memberSince" readonly>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Update Profile
                            </button>
                        </form>
                    </div>

                    <!-- Orders Tab -->
                    <div id="ordersTab" class="tab-content" style="display: none;">
                        <h2 class="section-title">My Orders</h2>
                        <div class="orders-list" id="ordersList">
                            <div class="empty-state">
                                <i class="fas fa-box-open"></i>
                                <h3>No orders yet</h3>
                                <p>Your order history will appear here</p>
                                <a href="shop.html" class="btn btn-primary" style="margin-top: 1rem;">Start Shopping</a>
                            </div>
                        </div>
                    </div>

                    <!-- Addresses Tab -->
                    <div id="addressesTab" class="tab-content" style="display: none;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                            <h2 class="section-title" style="margin: 0;">My Addresses</h2>
                            <button class="btn btn-primary" onclick="showAddAddressForm()">
                                <i class="fas fa-plus"></i> Add Address
                            </button>
                        </div>
                        <div class="address-grid" id="addressesGrid">
                            <div class="empty-state">
                                <i class="fas fa-map-marker-alt"></i>
                                <h3>No addresses saved</h3>
                                <p>Add your delivery addresses for faster checkout</p>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-main">
            <div class="container">
                <div class="footer-grid">
                    <div class="footer-brand">
                        <a href="index.html" class="footer-logo">
                            <img src="https://i.imgur.com/gWdOYdW.png" alt="Al Saraya">
                        </a>
                        <p>Your trusted source for premium quality halal meats since 1995. We're committed to excellence in every cut.</p>
                        <div class="footer-social">
                            <a href="#"><i class="fab fa-facebook-f"></i></a>
                            <a href="#"><i class="fab fa-instagram"></i></a>
                            <a href="#"><i class="fab fa-whatsapp"></i></a>
                            <a href="#"><i class="fab fa-twitter"></i></a>
                        </div>
                    </div>
                    <div class="footer-links">
                        <h4>Quick Links</h4>
                        <ul>
                            <li><a href="index.html">Home</a></li>
                            <li><a href="shop.html">Shop</a></li>
                            <li><a href="tracking.html">Track Order</a></li>
                            <li><a href="index.html#contact">Contact</a></li>
                        </ul>
                    </div>
                    <div class="footer-links">
                        <h4>Categories</h4>
                        <ul>
                            <li><a href="shop.html">Beef</a></li>
                            <li><a href="shop.html">Lamb</a></li>
                            <li><a href="shop.html">Chicken</a></li>
                            <li><a href="shop.html">Specialty</a></li>
                        </ul>
                    </div>
                    <div class="footer-links">
                        <h4>Support</h4>
                        <ul>
                            <li><a href="#">Privacy Policy</a></li>
                            <li><a href="#">Terms of Service</a></li>
                            <li><a href="#">Delivery Info</a></li>
                            <li><a href="#">FAQ</a></li>
                        </ul>
                    </div>
                    <div class="footer-contact">
                        <h4>Contact Info</h4>
                        <ul>
                            <li><i class="fas fa-map-marker-alt"></i> Al Bateen, Abu Dhabi</li>
                            <li><i class="fas fa-phone-alt"></i> (02) 333 9111</li>
                            <li><i class="fas fa-envelope"></i> info@alsarayabutchery.com</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="footer-bottom">
            <div class="container">
                <p>&copy; 2026 Al Saraya Butchery. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Mobile Bottom Navigation -->
    <nav class="mobile-nav" id="mobileNav">
        <a href="index.html" class="mobile-nav-item">
            <i class="fas fa-home"></i>
            <span>Home</span>
        </a>
        <a href="shop.html" class="mobile-nav-item">
            <i class="fas fa-store"></i>
            <span>Shop</span>
        </a>
        <a href="#" class="mobile-nav-item cart-nav-item" id="cartNavBtn">
            <i class="fas fa-shopping-cart"></i>
            <span class="mobile-cart-count" id="mobileCartCount">0</span>
            <span>Cart</span>
        </a>
        <a href="tracking.html" class="mobile-nav-item">
            <i class="fas fa-truck"></i>
            <span>Track</span>
        </a>
        <a href="profile.html" class="mobile-nav-item active">
            <i class="fas fa-user"></i>
            <span>Profile</span>
        </a>
    </nav>

    <!-- Cart Modal -->
    <div class="cart-modal" id="cartModal">
        <div class="cart-overlay" id="cartOverlay"></div>
        <div class="cart-drawer">
            <div class="cart-header">
                <h3><i class="fas fa-shopping-cart"></i> Shopping Cart</h3>
                <button class="cart-close" id="cartClose">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="cart-items" id="cartItems"></div>
            <div class="cart-footer">
                <div class="cart-total">
                    <span>Total:</span>
                    <span id="cartTotal">0.00 AED</span>
                </div>
                <button class="btn btn-primary btn-block" onclick="proceedToCheckout()">
                    Proceed to Checkout <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- App JS -->
    <script src="app.js"></script>
    
    <!-- Authentication JS -->
    <script src="auth.js"></script>

    <!-- Authentication Modals -->
    <div class="auth-modal" id="authModal"></div>
    <div class="profile-modal" id="profileModal" style="display: none;"></div>
    
    <!-- Addresses Modal -->
    <div class="addresses-modal" id="addressesModal" style="display: none;">
        <div class="auth-overlay" onclick="closeAddressesModal()"></div>
        <div class="addresses-container">
            <button class="auth-close" onclick="closeAddressesModal()"><i class="fas fa-times"></i></button>
            <div class="addresses-header">
                <h2><i class="fas fa-map-marker-alt"></i> My Addresses</h2>
                <button class="btn btn-primary" onclick="showAddAddressForm()"><i class="fas fa-plus"></i> Add New</button>
            </div>
            <div class="addresses-list" id="addressesList"></div>
            <div class="address-form-container" id="addressFormContainer" style="display: none;">
                <h3 id="addressFormTitle">Add New Address</h3>
                <form class="address-form" id="addressForm">
                    <input type="hidden" id="addressId" />
                    <div class="form-row">
                        <div class="form-group">
                            <label>Label</label>
                            <select id="addressLabel" required>
                                <option value="Home">Home</option>
                                <option value="Work">Work</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Full Name</label>
                            <input type="text" id="addressFullName" required />
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Phone Number</label>
                            <input type="tel" id="addressPhone" required />
                        </div>
                        <div class="form-group">
                            <label>Area</label>
                            <input type="text" id="addressArea" required />
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Street Address <small>(Drag the marker or click "Use My Location" on map)</small></label>
                        <input type="text" id="addressStreet" required placeholder="Address will be filled from map..." />
                        
                        <!-- Saved Address Quick-Select Buttons -->
                        <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap;">
                            <div id="savedAddressButtons" style="display: flex; gap: 0.5rem; flex-wrap: wrap; width: 100%;"></div>
                        </div>
                        
                        <div id="addressMap" style="width: 100%; height: 400px; border-radius: 8px; margin-top: 0.5rem; border: 2px solid var(--border);"></div>
                        <small style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 0.5rem; display: block;">
                            <i class="fas fa-info-circle"></i> Click "Use My Location" button on map, drag marker, or click anywhere on the map
                        </small>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Building</label>
                            <input type="text" id="addressBuilding" />
                        </div>
                        <div class="form-group">
                            <label>Floor</label>
                            <input type="text" id="addressFloor" />
                        </div>
                        <div class="form-group">
                            <label>Apartment</label>
                            <input type="text" id="addressApartment" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Landmark (Optional)</label>
                        <input type="text" id="addressLandmark" />
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="addressDefault" />
                            Set as default address
                        </label>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-outline" onclick="hideAddressForm()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Address</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Check if user is logged in
        async function checkAuth() {
            if (!window.getCurrentUser || !window.getCurrentUser()) {
                window.location.href = 'index.html?login=required';
                return false;
            }
            return true;
        }

        // Load user profile data
        async function loadUserData() {
            const user = window.getCurrentUser ? window.getCurrentUser() : null;
            const profile = window.getUserProfile ? window.getUserProfile() : null;
            
            if (!user) {
                await checkAuth();
                return;
            }

            // Update sidebar
            document.getElementById('profileName').textContent = profile?.full_name || 'Guest User';
            document.getElementById('profilePhone').textContent = profile?.phone_number || user.phoneNumber || 'No phone';
            
            // Update profile avatar
            const initials = (profile?.full_name || 'G').split(' ').map(n => n[0]).join('').toUpperCase();
            document.getElementById('profileAvatar').innerHTML = initials;

            // Update form fields
            document.getElementById('fullName').value = profile?.full_name || '';
            document.getElementById('email').value = profile?.email || '';
            document.getElementById('phone').value = profile?.phone_number || user.phoneNumber || '';
            
            // Format member since date
            const memberSince = profile?.created_at ? new Date(profile.created_at).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            }) : 'Recently';
            document.getElementById('memberSince').value = memberSince;

            // Load orders
            await loadUserOrders();
            
            // Load addresses
            await loadUserAddressesTab();
        }

        // Load user orders
        async function loadUserOrders() {
            const ordersList = document.getElementById('ordersList');
            const user = window.getCurrentUser ? window.getCurrentUser() : null;
            
            if (!user) return;

            try {
                const { data: orders, error } = await supabase
                    .from('orders')
                    .select('*')
                    .eq('user_id', user.uid)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                if (orders && orders.length > 0) {
                    ordersList.innerHTML = orders.map(order => {
                        const statusClass = `status-${(order.status || 'pending').toLowerCase()}`;
                        const items = order.items ? JSON.parse(order.items) : [];
                        // Convert order.id to string to handle UUID
                        const orderId = String(order.id || '').substring(0, 8);
                        
                        return `
                            <div class="order-card">
                                <div class="order-header">
                                    <div class="order-id">#${orderId}</div>
                                    <div class="order-status ${statusClass}">${order.status || 'Pending'}</div>
                                </div>
                                <div class="order-details">
                                    <div class="order-detail-item">
                                        <label>Order Date</label>
                                        <span>${new Date(order.created_at).toLocaleDateString()}</span>
                                    </div>
                                    <div class="order-detail-item">
                                        <label>Total Amount</label>
                                        <span>${(order.total_amount || 0).toFixed(2)} AED</span>
                                    </div>
                                    <div class="order-detail-item">
                                        <label>Payment Method</label>
                                        <span>${order.payment_method === 'cod' ? 'Cash on Delivery' : 'Card'}</span>
                                    </div>
                                </div>
                                <div class="order-items">
                                    <h4>Items (${items.length})</h4>
                                    ${items.map(item => `
                                        <div class="order-item">
                                            <span>${item.name} (${item.quantity} ${item.unit || 'pcs'})</span>
                                            <span>${(item.price * item.quantity).toFixed(2)} AED</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    ordersList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-box-open"></i>
                            <h3>No orders yet</h3>
                            <p>Your order history will appear here</p>
                            <a href="shop.html" class="btn btn-primary" style="margin-top: 1rem;">Start Shopping</a>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading orders:', error);
                showNotification('Failed to load orders', 'error');
            }
        }

        // Load user addresses for the tab
        async function loadUserAddressesTab() {
            const addressesGrid = document.getElementById('addressesGrid');
            const addresses = window.getUserAddresses ? window.getUserAddresses() : [];
            
            if (!addresses || addresses.length === 0) {
                addressesGrid.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-map-marker-alt"></i>
                        <h3>No addresses saved</h3>
                        <p>Add your delivery addresses for faster checkout</p>
                    </div>
                `;
                return;
            }

            addressesGrid.innerHTML = addresses.map(addr => `
                <div class="address-card ${addr.is_default ? 'default' : ''}">
                    <div class="address-label">${addr.label || 'Home'}${addr.is_default ? ' (Default)' : ''}</div>
                    <div class="address-name">${addr.full_name}</div>
                    <div class="address-text">
                        ${addr.phone_number}<br>
                        ${addr.street_address}<br>
                        ${[addr.building, addr.floor, addr.apartment].filter(Boolean).join(', ')}<br>
                        ${addr.area}
                        ${addr.landmark ? '<br>Landmark: ' + addr.landmark : ''}
                    </div>
                    <div class="address-actions">
                        <button class="btn-edit" onclick="editAddress('${addr.id}')">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn-delete" onclick="confirmDeleteAddress('${addr.id}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Tab switching
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
            
            // Show selected tab
            document.getElementById(tabName + 'Tab').style.display = 'block';
            
            // Update active menu item
            document.querySelectorAll('.profile-menu a').forEach(link => link.classList.remove('active'));
            // Find the link that was clicked by matching the onclick attribute
            const activeLink = document.querySelector(`.profile-menu a[onclick*="showTab('${tabName}')"]`);
            if (activeLink) activeLink.classList.add('active');
            
            // Load addresses when addresses tab is shown
            if (tabName === 'addresses') {
                loadUserAddressesTab();
            }
        }

        // Update profile form submission
        document.getElementById('updateProfileForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const fullName = document.getElementById('fullName').value;
            const email = document.getElementById('email').value;
            
            try {
                await updateUserProfile({ full_name: fullName, email: email });
                showNotification('Profile updated successfully!', 'success');
                // Reload user data to update sidebar
                await loadUserData();
            } catch (error) {
                console.error('Error updating profile:', error);
                showNotification('Failed to update profile', 'error');
            }
        });
        
        // Note: Address form submission is handled in auth.js to avoid duplicate submissions
        // DO NOT add another listener here
        
        // Close addresses modal
        function closeAddressesModal() {
            const modal = document.getElementById('addressesModal');
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = '';
            }
            // Reset form view
            hideAddressForm();
        }
        
        // Hide address form and show addresses list
        function hideAddressForm() {
            const addressesList = document.getElementById('addressesList');
            const formContainer = document.getElementById('addressFormContainer');
            
            if (addressesList) addressesList.style.display = 'block';
            if (formContainer) formContainer.style.display = 'none';
            
            // Clear form
            const form = document.getElementById('addressForm');
            if (form) form.reset();
            document.getElementById('addressId').value = '';
        }
        
        // Edit address
        async function editAddress(addressId) {
            const addresses = window.getUserAddresses ? window.getUserAddresses() : [];
            const address = addresses.find(a => a.id === addressId);
            
            if (!address) {
                showNotification('Address not found', 'error');
                return;
            }
            
            // Open modal and show form
            const modal = document.getElementById('addressesModal');
            if (modal) {
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }
            
            const addressesList = document.getElementById('addressesList');
            const formContainer = document.getElementById('addressFormContainer');
            const formTitle = document.getElementById('addressFormTitle');
            
            if (addressesList) addressesList.style.display = 'none';
            if (formContainer) formContainer.style.display = 'block';
            if (formTitle) formTitle.textContent = 'Edit Address';
            
            // Fill form with address data
            document.getElementById('addressId').value = address.id;
            document.getElementById('addressLabel').value = address.label || 'Home';
            document.getElementById('addressFullName').value = address.full_name || '';
            document.getElementById('addressPhone').value = address.phone_number || '';
            document.getElementById('addressArea').value = address.area || '';
            document.getElementById('addressStreet').value = address.street_address || '';
            document.getElementById('addressBuilding').value = address.building || '';
            document.getElementById('addressFloor').value = address.floor || '';
            document.getElementById('addressApartment').value = address.apartment || '';
            document.getElementById('addressLandmark').value = address.landmark || '';
            document.getElementById('addressDefault').checked = address.is_default || false;
        }
        
        // Confirm delete address
        function confirmDeleteAddress(addressId) {
            if (confirm('Are you sure you want to delete this address? This action cannot be undone.')) {
                deleteAddress(addressId);
            }
        }
        
        // Delete address
        async function deleteAddress(addressId) {
            const user = window.getCurrentUser ? window.getCurrentUser() : null;
            if (!user) return;
            
            try {
                const { error } = await supabase
                    .from('user_addresses')
                    .delete()
                    .eq('id', addressId)
                    .eq('user_id', user.uid);
                
                if (error) throw error;
                
                showNotification('Address deleted successfully', 'success');
                
                // Reload addresses in auth.js cache
                if (window.loadUserAddresses) {
                    await window.loadUserAddresses();
                }
                
                // Refresh the addresses grid AND the map buttons
                await loadUserAddressesTab();
                loadSavedAddressButtons();
            } catch (error) {
                console.error('Error deleting address:', error);
                showNotification('Failed to delete address', 'error');
            }
        }
        
        // Function to show add address form directly (without showing addresses list first)
        function showAddAddressForm() {
            // Open the addresses modal
            const modal = document.getElementById('addressesModal');
            if (modal) {
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }
            
            // Hide the addresses list and show the form immediately
            const addressesList = document.getElementById('addressesList');
            const formContainer = document.getElementById('addressFormContainer');
            const formTitle = document.getElementById('addressFormTitle');
            
            if (addressesList) addressesList.style.display = 'none';
            if (formContainer) {
                formContainer.style.display = 'block';
                if (formTitle) formTitle.textContent = 'Add New Address';
                
                // Clear form
                const form = document.getElementById('addressForm');
                if (form) form.reset();
                document.getElementById('addressId').value = '';
                
                // Focus first input
                setTimeout(() => {
                    const firstInput = document.getElementById('addressLabel');
                    if (firstInput) firstInput.focus();
                }, 100);
            }
        }

        // Initialize page
        window.addEventListener('load', async () => {
            // Setup cart button (desktop & mobile)
            const cartBtn = document.getElementById('cartBtn');
            const cartNavBtn = document.getElementById('cartNavBtn');
            const cartModal = document.getElementById('cartModal');
            const cartClose = document.getElementById('cartClose');
            const cartOverlay = document.getElementById('cartOverlay');
            
            function openCart() {
                if (cartModal) {
                    cartModal.classList.add('active');
                    document.body.style.overflow = 'hidden';
                    // Display cart if function exists
                    if (typeof displayCart === 'function') displayCart();
                }
            }
            
            function closeCart() {
                if (cartModal) {
                    cartModal.classList.remove('active');
                    document.body.style.overflow = '';
                }
            }
            
            if (cartBtn) cartBtn.addEventListener('click', openCart);
            if (cartNavBtn) cartNavBtn.addEventListener('click', (e) => {
                e.preventDefault();
                openCart();
            });
            if (cartClose) cartClose.addEventListener('click', closeCart);
            if (cartOverlay) cartOverlay.addEventListener('click', closeCart);
            
            // Wait for auth to initialize
            await waitForAuth();
            await loadUserData();
            
            // Check for URL parameters to switch tabs
            const urlParams = new URLSearchParams(window.location.search);
            const tab = urlParams.get('tab');
            if (tab) {
                showTab(tab);
            }
            
            // Register callback for address updates (called by auth.js after save)
            window.onAddressUpdated = function() {
                console.log('Address updated, refreshing UI...');
                loadUserAddressesTab(); // Refresh addresses grid
                loadSavedAddressButtons(); // Refresh quick-select buttons
            };
            
            // Initialize Google Maps Autocomplete after a short delay
            setTimeout(initializeAddressAutocomplete, 1000);
        });
        
        // Initialize Google Maps with draggable marker
        let addressMap, addressMarker; // Make global so buttons can access
        
        function initializeAddressAutocomplete() {
            if (typeof google === 'undefined' || !google.maps) {
                console.log('Google Maps not loaded yet, will retry...');
                setTimeout(initializeAddressAutocomplete, 1000);
                return;
            }
            
            const mapDiv = document.getElementById('addressMap');
            if (!mapDiv) return;
            
            // Default to Dubai coordinates
            const defaultLocation = { lat: 25.2048, lng: 55.2708 };
            
            // Create the map with geolocation control
            addressMap = new google.maps.Map(mapDiv, {
                center: defaultLocation,
                zoom: 13,
                mapTypeControl: false,
                streetViewControl: false,
                fullscreenControl: true,
                zoomControl: true,
                zoomControlOptions: {
                    position: google.maps.ControlPosition.RIGHT_CENTER
                }
            });
            
            // Add Google's native geolocation control button
            const locationButton = document.createElement('button');
            locationButton.textContent = 'Use My Location';
            locationButton.classList.add('btn', 'btn-primary');
            locationButton.style.margin = '10px';
            locationButton.style.fontSize = '14px';
            locationButton.style.padding = '8px 16px';
            
            addressMap.controls[google.maps.ControlPosition.TOP_CENTER].push(locationButton);
            
            locationButton.addEventListener('click', () => {
                if (navigator.geolocation) {
                    locationButton.textContent = 'Locating...';
                    locationButton.disabled = true;
                    
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const pos = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            };
                            
                            addressMap.setCenter(pos);
                            addressMarker.setPosition(pos);
                            
                            // Try to geocode
                            const geocoder = new google.maps.Geocoder();
                            geocoder.geocode({ location: pos }, (results, status) => {
                                console.log('Geocoding status:', status);
                                console.log('Geocoding results:', results);
                                
                                if (status === 'OK' && results[0]) {
                                    document.getElementById('addressStreet').value = results[0].formatted_address;
                                    
                                    // Try to extract area
                                    for (const component of results[0].address_components) {
                                        const types = component.types;
                                        if (types.includes('sublocality_level_1') || types.includes('neighborhood') || types.includes('locality')) {
                                            const areaInput = document.getElementById('addressArea');
                                            if (areaInput && !areaInput.value) {
                                                areaInput.value = component.long_name;
                                                break;
                                            }
                                        }
                                    }
                                } else if (status === 'REQUEST_DENIED') {
                                    console.error('ðŸš¨ Geocoding API ERROR:', status);
                                    console.error('This usually means:');
                                    console.error('1. Your API key has HTTP referrer restrictions');
                                    console.error('2. Geocoding API is not enabled for THIS specific API key');
                                    console.error('3. Billing is not enabled on your Google Cloud project');
                                    console.error('\nCheck: https://console.cloud.google.com/google/maps-apis/credentials');
                                    alert('âš ï¸ Geocoding API Access Denied\n\nYour API key cannot access Geocoding API.\n\nPossible causes:\nâ€¢ API key has referrer restrictions\nâ€¢ Geocoding API not enabled for this key\nâ€¢ Billing not enabled\n\nCheck browser console for details.');
                                    document.getElementById('addressStreet').value = `Lat: ${pos.lat.toFixed(6)}, Lng: ${pos.lng.toFixed(6)}`;
                                } else {
                                    console.warn('Geocoding failed with status:', status);
                                    document.getElementById('addressStreet').value = `Lat: ${pos.lat.toFixed(6)}, Lng: ${pos.lng.toFixed(6)} (${status})`;
                                }
                            });
                            
                            locationButton.textContent = 'Use My Location';
                            locationButton.disabled = false;
                        },
                        () => {
                            alert('Error: Could not get your location. Please enable location permissions.');
                            locationButton.textContent = 'Use My Location';
                            locationButton.disabled = false;
                        }
                    );
                } else {
                    alert('Error: Your browser does not support geolocation.');
                }
            });
            
            // Create a draggable marker
            addressMarker = new google.maps.Marker({
                position: defaultLocation,
                map: addressMap,
                draggable: true,
                animation: google.maps.Animation.DROP,
                title: 'Drag me to your location'
            });
            
            // Geocoder for reverse geocoding (OPTIONAL - may not be enabled in API)
            const geocoder = new google.maps.Geocoder();
            
            // Function to update address from coordinates
            function updateAddressFromLocation(lat, lng) {
                // Try geocoding, but don't fail if API is not enabled
                geocoder.geocode({ location: { lat, lng } }, (results, status) => {
                    console.log('Drag geocoding status:', status);
                    
                    if (status === 'OK' && results[0]) {
                        console.log('Geocode results:', results[0]);
                        
                        // Extract address components
                        let streetNumber = '';
                        let route = '';
                        let area = '';
                        let city = '';
                        
                        for (const component of results[0].address_components) {
                            const types = component.types;
                            
                            if (types.includes('street_number')) {
                                streetNumber = component.long_name;
                            }
                            if (types.includes('route')) {
                                route = component.long_name;
                            }
                            if (types.includes('sublocality_level_1') || types.includes('neighborhood')) {
                                area = component.long_name;
                            }
                            if (types.includes('locality')) {
                                city = component.long_name;
                            }
                        }
                        
                        // Auto-fill the street address
                        const streetAddress = [streetNumber, route].filter(Boolean).join(' ') || results[0].formatted_address;
                        document.getElementById('addressStreet').value = streetAddress;
                        
                        // Auto-fill the area if found
                        if (area || city) {
                            const areaInput = document.getElementById('addressArea');
                            if (areaInput && !areaInput.value) {
                                areaInput.value = area || city;
                            }
                        }
                        
                        console.log('Address updated:', streetAddress, 'Area:', area || city);
                    } else if (status === 'REQUEST_DENIED') {
                        console.error('ðŸš¨ Geocoding API REQUEST_DENIED');
                        console.error('Check: https://console.cloud.google.com/google/maps-apis/credentials');
                        console.error('Ensure Geocoding API is enabled for key: AIzaSyAqs6k9yZisdszgk-eUYZIryRyRSEgVR6M');
                        // Show coordinates as fallback
                        document.getElementById('addressStreet').value = `Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)} (API Key Error)`;
                    } else {
                        console.warn('Geocoder status:', status);
                        document.getElementById('addressStreet').value = `Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)} (${status})`;
                    }
                });
            }
            
            // Update address when marker is dragged
            addressMarker.addListener('dragend', function() {
                const position = addressMarker.getPosition();
                updateAddressFromLocation(position.lat(), position.lng());
            });
            
            // Don't auto-locate on page load, let user click button instead
            
            // Add click on map to move marker
            addressMap.addListener('click', function(event) {
                addressMarker.setPosition(event.latLng);
                updateAddressFromLocation(event.latLng.lat(), event.latLng.lng());
            });
            
            // Load saved address quick-select buttons
            loadSavedAddressButtons();
        }
        
        // Load saved address buttons for quick selection
        function loadSavedAddressButtons() {
            const container = document.getElementById('savedAddressButtons');
            if (!container) {
                console.log('savedAddressButtons container not found');
                return;
            }
            
            const addresses = window.getUserAddresses ? window.getUserAddresses() : [];
            console.log('loadSavedAddressButtons (profile) - Addresses:', addresses);
            
            if (addresses && addresses.length > 0) {
                container.innerHTML = addresses.map(addr => `
                    <button type="button" class="btn btn-outline" onclick="selectSavedAddressForMap('${addr.id}')" style="font-size: 0.85rem; padding: 0.4rem 0.8rem;">
                        <i class="fas fa-map-pin"></i> ${addr.label || 'Home'}
                    </button>
                `).join('');
            } else {
                container.innerHTML = '<small style="color: var(--text-secondary); align-self: center;">No saved addresses yet</small>';
            }
        }
        
        // Select a saved address and move map to it
        function selectSavedAddressForMap(addressId) {
            const addresses = window.getUserAddresses ? window.getUserAddresses() : [];
            const address = addresses.find(a => a.id === addressId);
            
            if (!address) return;
            
            // Fill form fields
            document.getElementById('addressStreet').value = address.street_address || '';
            document.getElementById('addressArea').value = address.area || '';
            document.getElementById('addressBuilding').value = address.building || '';
            document.getElementById('addressFloor').value = address.floor || '';
            document.getElementById('addressApartment').value = address.apartment || '';
            document.getElementById('addressLandmark').value = address.landmark || '';
            
            // Note: We can't geocode the address to get coordinates without the Geocoding API
            // User can still see the form is filled and adjust the marker manually if needed
            alert(`Address loaded: ${address.street_address}\\nDrag the map marker to your exact location.`);
        }
        
        // Wait for auth to be ready
        async function waitForAuth() {
            return new Promise((resolve) => {
                let attempts = 0;
                const checkAuth = setInterval(() => {
                    attempts++;
                    
                    // Check if Firebase is ready
                    if (typeof firebase !== 'undefined' && firebase.auth) {
                        const firebaseUser = firebase.auth().currentUser;
                        
                        // If no Firebase user, redirect to login
                        if (!firebaseUser && attempts > 10) {
                            clearInterval(checkAuth);
                            console.log('No user logged in - redirecting');
                            window.location.href = 'index.html?login=required';
                            resolve();
                            return;
                        }
                        
                        // If Firebase user exists, wait for profile to sync
                        if (firebaseUser) {
                            const user = window.getCurrentUser ? window.getCurrentUser() : null;
                            const profile = window.getUserProfile ? window.getUserProfile() : null;
                            
                            // Profile is loaded, we're ready
                            if (user && profile) {
                                clearInterval(checkAuth);
                                console.log('Auth ready with profile:', profile);
                                resolve();
                                return;
                            }
                        }
                    }
                    
                    // Timeout after 5 seconds
                    if (attempts > 50) {
                        clearInterval(checkAuth);
                        console.log('Auth wait timeout');
                        resolve();
                    }
                }, 100);
            });
        }
    </script>
</body>
</html>
